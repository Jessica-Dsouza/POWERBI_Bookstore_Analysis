"use strict";
this.parseTimeMarkers = this.parseTimeMarkers || {};
var marker = this.parseTimeMarkers['mapVisuals.min.js'] || (this.parseTimeMarkers['mapVisuals.min.js'] = {});
marker.startEval = window.jsCommon && window.jsCommon.performance && window.jsCommon.performance.now ? window.jsCommon.performance.now() : Date.now(); marker.isExternal = false;
if (window.perfTracking && window.perfTracking.startBundleEval) window.perfTracking.startBundleEval('mapVisuals.min.js');var es6,powerbi,__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,a=1,i=arguments.length;a<i;a++)for(var o in e=arguments[a])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(t,s,r,l){return new(r=r||Promise)(function(a,e){function i(t){try{n(l.next(t))}catch(t){e(t)}}function o(t){try{n(l.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?a(t.value):((e=t.value)instanceof r?e:new r(function(t){t(e)})).then(i,o)}n((l=l.apply(t,s||[])).next())})},__generator=this&&this.__generator||function(i,o){var n,s,r,l={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(a){return function(t){var e=[a,t];if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,s&&(r=2&e[0]?s.return:e[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,e[1])).done)return r;switch(s=0,(e=r?[2&e[0],r.value]:e)[0]){case 0:case 1:r=e;break;case 4:return l.label++,{value:e[1],done:!1};case 5:l.label++,s=e[1],e=[0];continue;case 7:e=l.ops.pop(),l.trys.pop();continue;default:if(!(r=0<(r=l.trys).length&&r[r.length-1])&&(6===e[0]||2===e[0])){l=0;continue}if(3===e[0]&&(!r||e[1]>r[0]&&e[1]<r[3]))l.label=e[1];else if(6===e[0]&&l.label<r[1])l.label=r[1],r=e;else{if(!(r&&l.label<r[2])){r[2]&&l.ops.pop(),l.trys.pop();continue}l.label=r[2],l.ops.push(e)}}e=o.call(i,l)}catch(t){e=[6,t],s=0}finally{n=r=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}};!function(yt){var ft=yt.visuals||(yt.visuals={}),s=yt.visuals.builder,bt=jsCommon.Color,o=yt.data.DataRoleHelper,Mt=yt.visuals.MapUtil,e=Mt.Settings,a=jsCommon.Trace,wt=jsCommon.Utility.parseNumber,Ct="Category",St="Series",st="Size",Dt="Y",Lt="X",Pt="Tooltips",rt="Gradient";function xt(t){this.isDestroyed=!1,this.warnings=[],this.maxLevelOfDetail=Mt.MaxLevelOfDetail,this.minLevelOfDetail=Mt.MinLevelOfDetail,t.filledMap?(this.dataPointRenderer=new ft.MapShapeDataPointRenderer(t.filledMapDataLabelsEnabled,t.tooltipsEnabled),this.filledMapDataLabelsEnabled=t.filledMapDataLabelsEnabled,this.isFilledMap=!0):(this.dataPointRenderer=new ft.MapBubbleDataPointRenderer(t.tooltipsEnabled),this.isFilledMap=!1),this.mapCredentials=e.BingKey,this.mapControlFactory=t.mapControlFactory,this.behavior=t.behavior,this.tooltipsEnabled=t.tooltipsEnabled,this.disableZooming=t.disableZooming,this.disablePanning=t.disablePanning,this.isLegendScrollable=!!t.behavior,this.viewChangeThrottleInterval=t.viewChangeThrottleInterval,this.enableCurrentLocation=t.enableCurrentLocation,this.boundsHaveBeenUpdated=!1,this.rescaleMap=t.rescaleMap,this.shouldSetSavedLocation=!0,this.dataPointLassoSelect=t.dataPointLassoSelect}function Tt(t,e){return null!=t&&_.isFinite(t)&&null!=e&&_.isFinite(e)}xt.prototype.init=function(t){var e=this.element=t.element;this.pendingGeocodingRender=0,this.eventManager=new jsCommon.BubblingEventManager(d3.select(e.get(0))),this.featureSwitches=t.featureSwitches,this.currentViewport=t.viewport,this.currentViewport.scale=this.currentViewport.scale||1,t.style||a.assertFail("Map style is missing"),this.style=t.style,this.host=t.host,this.dataPointLassoSelect=this.dataPointLassoSelect&&t.featureSwitches.dataPointLassoSelect,this.behavior&&(this.interactivityService=ft.createInteractivityService(this.host)),this.legend=yt.visuals.createLegend(e,t.interactivity&&t.interactivity.isInteractiveLegend,this.interactivityService,this.isLegendScrollable,void 0,this.style,this.host),this.geoTaggingAnalyzerService=yt.geoTaggingAnalyzerServiceModuleFactory().create(t.host.getLocalizedString.bind(t.host)),this.tooltipService=ft.createTooltipService(this.host),this.host.locale&&(this.locale=this.host.locale()),this.geocoder=this.host.geocoder(),this.promiseFactory=this.host.promiseFactory(),this.mapTheme=ft.BingMapTheme.defaultTheme,this.resetBounds(),this.isDestroyed=!1},xt.prototype.destroy=function(){this.isDestroyed=!0;var t=this.mapControl;t&&(this.mapControl=void 0,setTimeout(function(){return t.dispose()},xt.MapControlDisposeDelay)),this.geocodingContext&&this.geocodingContext.timeout&&this.geocodingContext.timeout.resolve(null)},xt.prototype.createCurrentLocation=function(t){var e,a=this;InJs.DomFactory.div().addClass("mapCurrentLocation").appendTo(t).on("click",function(){a.isCurrentLocation?(e&&a.mapControl.entities.remove(e),a.updateInternal(!1,!1),a.isCurrentLocation=!1):a.host.geolocation().getCurrentPosition(function(t){t=new Microsoft.Maps.Location(t.coords.latitude,t.coords.longitude);e&&a.mapControl.entities.remove(e),e=Mt.CurrentLocation.createPushpin(t),a.mapControl.entities.push(e),a.updateMapView(t,11),a.isCurrentLocation=!0})})},xt.prototype.addDataPoint=function(t,e){if(t===this.geocodingContext){if(--t.dataPointsRemaining,!_.isEmpty(e.paths))for(var a=0,i=e.paths;a<i.length;a++)var o=i[a],n=Mt.expandLocationRect(n,o.adjustedBounds);n||(n={west:(t=e.location).longitude,east:t.longitude,north:t.latitude,south:t.latitude}),this.updateBounds(n),this.scheduleRedraw()}},xt.prototype.geocodingFailed=function(t){this.isDestroyed||t!==this.geocodingContext||--t.dataPointsRemaining<=0&&this.scheduleRedraw()},xt.prototype.scheduleRedraw=function(){var t=this;this.geocodingContext.dataPointsRemaining,this.pendingGeocodingRender&&this.geocodingContext.dataPointsRemaining<=0&&(clearTimeout(this.pendingGeocodingRender),this.pendingGeocodingRender=0),!this.pendingGeocodingRender&&this.mapControl&&(this.pendingGeocodingRender=setTimeout(function(){t.updateInternal(!0,!0),t.pendingGeocodingRender=0},this.geocodingContext.dataPointsRemaining<=0?0:xt.ScheduleRedrawInterval))},xt.prototype.enqueueGeoCode=function(e,a,i){var o=this,t=this.geocoder.tryGeocodeImmediate(a.queryLocation,0);t?this.completeGeoCode(e,a,t):this.geocoder.geocode(a.queryLocation,0,{timeout:e.timeout.promise,credentials:this.mapCredentials}).then(function(t){o.isDestroyed||e!==o.geocodingContext||(Mt.latLongIsInvalid(t,!0)?(o.warningsSet&&!i.invalidLatLongCoordinatesFound&&(o.warnings.push(new ft.InvalidLatLongWarning),o.host.setWarnings(o.warnings)),i.invalidLatLongCoordinatesFound=!0,o.geocodingFailed(e)):o.completeGeoCode(e,a,t))},function(t){return o.geocodingFailed(e)})},xt.prototype.completeGeoCode=function(t,e,a){e.location=a,this.addDataPoint(t,e)},xt.prototype.enqueueGeoCodeAndGeoShape=function(e,a,i,o){var n=this,t=this.geocoder.tryGeocodeImmediate(a.queryLocation,0);t?this.completeGeoCodeAndGeoShape(e,a,i,t):this.geocoder.geocode(a.queryLocation,0,{timeout:e.timeout.promise,credentials:this.mapCredentials}).then(function(t){n.isDestroyed||e!==n.geocodingContext||(Mt.latLongIsInvalid(t,!0)?(n.warningsSet&&!o.invalidLatLongCoordinatesFound&&(n.warnings.push(new ft.InvalidLatLongWarning),n.host.setWarnings(n.warnings)),o.invalidLatLongCoordinatesFound=!0,n.geocodingFailed(e)):n.completeGeoCodeAndGeoShape(e,a,i,t))},function(t){return n.geocodingFailed(e)})},xt.prototype.completeGeoCodeAndGeoShape=function(t,e,a,i){e.location=i,this.enqueueGeoShape(t,e,a)},xt.prototype.enqueueGeoShape=function(e,a,i){var o=this,t=(a.location,this.geocoder.tryGeocodeBoundaryImmediate({latitude:a.location.latitude,longitude:a.location.longitude,category:this.geocodingCategory,levelOfDetail:i.level,maxGeoData:i.maxPolygons,entityType:a.location.entityType},0));t?this.completeGeoShape(e,a,i,t):this.geocoder.geocodeBoundary({latitude:a.location.latitude,longitude:a.location.longitude,category:this.geocodingCategory,levelOfDetail:i.level,maxGeoData:i.maxPolygons,entityType:a.location.entityType},0,{timeout:e.timeout.promise,credentials:this.mapCredentials}).then(function(t){!o.isDestroyed&&t&&e===o.geocodingContext&&o.completeGeoShape(e,a,i,t)},function(t){return o.geocodingFailed(e)})},xt.prototype.completeGeoShape=function(t,e,a,i){Mt.calcShapeData(i.locations),e.paths=ft.MapShapeDataPointRenderer.buildPaths(i.locations),this.addDataPoint(t,e)},xt.prototype.getOptimumLevelOfDetail=function(t,e,a){var i=this.dataPointRenderer.getDataPointCount();if(0!==i){var o,n=this.dataPointRenderer.getDataPointPadding(),s=this.dataPointRenderer.getEnclosingBounds&&this.dataPointRenderer.getEnclosingBounds();if(s)s.west=a.west,s.east=a.east;else if(1===i){switch(this.geocodingCategory){case Mt.CategoryTypes.Continent:o=130;break;case Mt.CategoryTypes.CountryRegion:o=90;break;case Mt.CategoryTypes.StateOrProvince:o=25;break;case Mt.CategoryTypes.County:o=3;break;case Mt.CategoryTypes.City:o=.7;break;case Mt.CategoryTypes.PostalCode:o=.3;break;case Mt.CategoryTypes.Place:o=.1;break;default:case Mt.CategoryTypes.Address:o=.04}s={west:a.west-o/2,north:this.maxLatitude,east:a.east+o/2,south:this.minLatitude}}else s={west:a.west,north:this.maxLatitude,east:a.east,south:this.minLatitude};for(var r=Mt.MaxLevelOfDetail;r>=Mt.MinLevelOfDetail;r--){var l=Mt.latLongToPixelXY(s.north,s.west,r,{unconstrained:!0}),u=Mt.latLongToPixelXY(s.south,s.east,r,{unconstrained:!0});if(Math.abs(u.x-l.x)+n<=t&&Math.abs(l.y-u.y)+n<=e)return r}}return this.minLevelOfDetail},xt.prototype.getMapView=function(t,e){var a=this.getSmallestEnclosingLongitudeRange(),i=Mt.normalizeLongitude((a.west+a.east)/2),t=this.getOptimumLevelOfDetail(t,e,a),e=(t<=Mt.MinLevelOfDetail&&(i=0),Mt.latLongToPixelXY(this.maxLatitude,i,t)),a=Mt.latLongToPixelXY(this.minLatitude,i,t);return{center:Mt.pixelXYToLocation((e.x+a.x)/2,(a.y+e.y)/2,t),levelOfDetail:t}},xt.prototype.getSmallestEnclosingLongitudeRange=function(){var t=this.longitudes;if(_.isEmpty(t))return{west:0,east:0};if(1===t.length)return{west:t[0].west,east:t[0].east};t.sort(function(t,e){return t.west-e.west});var e=t[0].west;if((s=_.maxBy(t,function(t){return t.east}).east)-e<=180)return{west:e,east:s};for(var a=e,i=s,o=i-a,n=1;n<t.length;++n){var s,e=t[n].west,r=(s=Math.max(s,t[n-1].east+360))-e;r<o&&(a=e,i=s,o=r)}return{west:a,east:i}},xt.prototype.resetBounds=function(){this.boundsHaveBeenUpdated=!1,this.minLatitude=Mt.MaxAllowedLatitude,this.maxLatitude=Mt.MinAllowedLatitude,this.longitudes=[]},xt.prototype.updateBounds=function(t){var e=t.west,a=t.east,i=t.south,t=t.north,a=a-e,e=Mt.normalizeLongitude(e);this.longitudes.push({west:e,east:e+a}),this.boundsHaveBeenUpdated=!0,i<this.minLatitude&&(this.minLatitude=i),t>this.maxLatitude&&(this.maxLatitude=t)},xt.prototype.renderLegend=function(t){var e=t.position;void 0!==e?this.legend.setPosition(e):this.legend.setPosition(ft.LegendPosition.Top),this.legend.drawLegend(t,this.currentViewport)},xt.calculateGroupSizes=function(t,e,a,i,o){for(var t=t.values[0].values.length,n=e.length,s=0,r=t;s<r;++s){var l=null;if(0<=i)for(var u=0;u<n;++u){var d=e[u].values[i].values[s];d&&(null===l?l=d:l+=d)}a.push(l),l&&(o?(o.min=Math.min(o.min,l),o.max=Math.max(o.max,l)):o={min:l,max:l})}return o},xt.calculateRadius=function(t,e,a){var i=t?t.max-t.min:0,o=6;return(o=null!=t&&null!=e&&0!=i?(e-t.min)/i*14+6:o)*(a=void 0===a?1:a)},xt.getGeocodingCategory=function(t,e){var a=t.type,a=e.getFieldTypeFromDescriptor(a);if(a)return a;var i=t.displayName;if(a=e.getFieldType(i))return a;i=t.roles;if(i)for(var o=Object.keys(i),n=0,s=o.length;n<s;++n){var r=e.getFieldType(o[n]);if(r)return r}},xt.hasSizeField=function(t,e){if(!_.isEmpty(t))for(var a=0,i=t.length;a<i;a++){var o=t[a].source.roles;if(!o&&a===e&&t[a].source.type.numeric)return!0;if(o)for(var n=Object.keys(o),s=0,r=n.length;s<r;s++)if(n[s]===st)return!0}return!1},xt.shouldEnumerateDataPoints=function(t,e,a){var i=o.hasRoleInDataView(t,St),e=e?st:rt,t=o.hasRoleInDataView(t,e),e=a&&a.showHeatMap;return(i||!t)&&!e},xt.shouldEnumerateHeatMap=function(t,e){return!(t&&t.dataPoints&&1<t.dataPoints.length)&&!e},xt.shouldEnumerateCategoryLabels=function(t,e,a){a=a&&a.showHeatMap;return(!t||e)&&!a},xt.prototype.getMapSettingsCard=function(e,a){var i=this,t=ft.mapProps.mapControls,o=ft.mapProps.mapStyles,n=__assign(__assign({},t),o),t=new s.FormattingCardBuilder(new s.FormattingCardUidBuilder("mapSettings"),"Visual_AzureMapsMapSettings",n,function(t){return e.getLocalizedString(t)});return t.addGroup("style",function(t){t.withDisplayName("Style"),t.addSimpleSlice("style",new s.DropdownBuilder({descriptor:n.mapTheme,value:a.mapTheme}).build(),function(t){return t.withCustomDisplayName("Style")}).addSimpleSlice("showLabels",new s.ToggleSwitchBuilder({descriptor:n.showLabels,value:a.showLabels}).build())}),t.addGroup("controls",function(t){t.withDisplayName("Controls"),t.addSimpleSlice("autoZoom",new s.ToggleSwitchBuilder({descriptor:n.autoZoom,value:a.autoZoomEnabled}).build()).addSimpleSlice("showZoomButtons",new s.ToggleSwitchBuilder({descriptor:n.showZoomButtons,value:a.showZoomButtons}).build());var e=xt.shouldEnumerateHeatMap(i.data&&i.data.legendData,i.isFilledMap);!i.plotLassoManager||e&&a.showHeatMap||t.addSimpleSlice("showLassoButton",new s.ToggleSwitchBuilder({descriptor:n.showLassoButton,value:a.showLassoButton}).build()),t.addSimpleSlice("geocodingCulture",new s.DropdownBuilder({descriptor:n.geocodingCulture,value:a.geocodingCulture||ft.GeocodingCulture.Default}).build())}),t.build()},xt.prototype.getLegendCard=function(t,e,a,i){return ft.Legend.getLegendFormattingModel({legendData:e},t,i,!a)},xt.prototype.getBubblesCard=function(e){function a(t){return i.host.getLocalizedString(t)}var i=this,o=ft.mapProps.bubbles,t=ft.mapProps.dataPoint,t=[t.fill,t.showAllDataPoints,t.defaultColor,o.bubbleSize],t=new ft.builder.FormattingCardBuilder(new ft.builder.FormattingCardUidBuilder("bubbles"),"Visual_Bubbles",t,a);return t.withDescription("Visual_BubblesDescription"),e&&!e.showHeatMap&&t.addGroup("size",function(t){t.withDisplayName("Role_DisplayName_Size"),t.addSimpleSlice("size",new s.SliderBuilder({descriptor:o.bubbleSize,value:ft.shapeUtil.invertBubbleSizeMultiplier(e.bubbleSizeMultiplier),localize:a,options:{minValue:{type:0,value:-30},maxValue:{type:1,value:100},unitSymbol:ft.visualLocKeys.PixelUnitSymbol}}).build())}),this.addDataPointsDetails(e,t,a),t.build()},xt.prototype.getFillColorsCard=function(t){function e(t){return a.host.getLocalizedString(t)}var a=this,i=ft.mapProps.dataPoint,i=[i.fill,i.showAllDataPoints,i.defaultColor],i=new ft.builder.FormattingCardBuilder(new ft.builder.FormattingCardUidBuilder("fillcolors"),"Visual_FillColors",i,e);return this.addDataPointsDetails(t,i,e),i.build()},xt.prototype.addDataPointsDetails=function(t,e,a){var i=this,o=this.data;o&&xt.shouldEnumerateDataPoints(this.dataView,this.isFilledMap,t)&&e.addGroup("colors",function(t){var e;if(t.withDisplayName("Visual_Colors"),o.hasSeries)return e={groupBuilder:t,dataPoints:ft.LegendData.toIEnumerableDataPoints(o.legendData),seriesColorProps:ft.mapProps.dataPoint,localize:a,featureSwitches:i.featureSwitches},yt.colorEnumerationHelperModuleFactory().appendSeriesColorSlicesToGroup(e);e={groupBuilder:t,colorProps:ft.mapProps.dataPoint,featureSwitches:i.featureSwitches,hostService:i.host,options:{dataView:i.dataView,style:i.style,categories:_.map(o.dataPoints,function(t){var e=t.subDataPoints[0];return{color:bt.normalizeToHexString(e.fill),displayName:t.categoryValue,identity:e.identity}}),fillInstanceKind:3}},yt.colorEnumerationHelperModuleFactory().appendCategoryColorSlicesToGroup(e)})},xt.prototype.getCategoryLabelCard=function(e,t,a,i){if(xt.shouldEnumerateCategoryLabels(this.isFilledMap,this.filledMapDataLabelsEnabled,a))return t={cardName:"Visual_CategoryLabels",dataLabelSettings:t,isShowCategory:!1,localize:function(t){return e.getLocalizedString(t)},props:a=ft.mapProps.categoryLabels,revertToDefaultProps:a,showBackground:!0,showValueColor:!0,style:i,featureSwitches:this.featureSwitches},ft.DataLabelViewModel.getCategoryLabelsCard(t)},xt.prototype.getHeatMapCard=function(){var e=this;if(this.data){var a,i,o,n,t=xt.shouldEnumerateHeatMap(this.data.legendData,this.isFilledMap);if(t)if(!this.data.legendData||_.isEmpty(this.data.legendData.dataPoints))return a=this.data.properties,i=function(t){return e.host.getLocalizedString(t)},o=ft.mapProps.heatMap,t=new s.FormattingCardBuilder(new s.FormattingCardUidBuilder("heatmap"),"Visual_HeatMap",o,i),n=ft.BingMapHeatMapUnit.maxRadiusPixels,a.heatMapOptions&&a.heatMapOptions.unit&&a.heatMapOptions.unit===ft.BingMapHeatMapUnit.meters&&(n=ft.BingMapHeatMapUnit.maxRadiusMeters),t.addTopLevelToggle("show",function(){return new ft.builder.ToggleSwitchBuilder({descriptor:__assign(__assign({},o.show),{selector:null}),value:a.showHeatMap}).build()}).addGroup("colors",function(t){t.withDisplayName("Visual_Colors").addSimpleSlice("color0",new s.ColorPickerBuilder({descriptor:__assign(__assign({},o.color0),{selector:null,instanceKind:1}),value:{value:a.heatMapOptions&&a.heatMapOptions.colorGradient["0.20"]}}).build()).addSimpleSlice("color50",new s.ColorPickerBuilder({descriptor:__assign(__assign({},o.color50),{selector:null,instanceKind:1}),value:{value:a.heatMapOptions&&a.heatMapOptions.colorGradient[.65]}}).build()).addSimpleSlice("color100",new s.ColorPickerBuilder({descriptor:__assign(__assign({},o.color100),{selector:null,instanceKind:1}),value:{value:a.heatMapOptions&&a.heatMapOptions.colorGradient["1.00"]}}).build())}).addGroup("options",function(t){t.withDisplayName("Desktop_FileMenu_Options").addSimpleSlice("radius",new s.SliderBuilder({descriptor:__assign(__assign({},o.filterRadius),{selector:null}),value:a.heatMapOptions&&a.heatMapOptions.radius,localize:i,options:{minValue:{type:0,value:1},maxValue:{type:1,value:n},unitSymbol:ft.visualLocKeys.PixelUnitSymbol}}).build()).addSimpleSlice("displayUnits",new s.DropdownBuilder({descriptor:__assign(__assign({},o.unit),{selector:null}),value:a.heatMapOptions&&a.heatMapOptions.unit}).build(),function(t){return t.withCustomDisplayName("Visual_DisplayUnits").withAliasName("Decimal")}).addSimpleSlice("transparency",s.SliderBuilder.getTransparencySliderBuilder({descriptor:__assign(__assign({},o.transparency),{selector:null}),value:a.heatMapOptions&&Math.round(100*(1-a.heatMapOptions.opacity)),localize:i}).build())}),t.build()}},xt.prototype.getFormattingModel=function(){var t=this,e=this.data?this.data.dataLabelSettings:xt.getDefaultMapLabelSettings(this.style),a=(this.data||xt.getDefaultMapData(this.style)).properties;return new ft.builder.FormattingModelBuilder(function(){return t.getMapSettingsCard(t.host,a)},function(){return t.getLegendCard(t.host,t.data&&t.data.legendData,t.hasSeries,t.featureSwitches)},function(){return t.isFilledMap?t.getFillColorsCard(a):t.getBubblesCard(a)},function(){return t.getCategoryLabelCard(t.host,e,a,t.style)},function(){return t.getHeatMapCard()}).build()},xt.prototype.enumerateObjectInstances=function(t){var e=new ft.ObjectEnumerationBuilder,a=this.data?this.data.dataLabelSettings:xt.getDefaultMapLabelSettings(this.style),i=(this.data||xt.getDefaultMapData(this.style)).properties;if(this.dataView){var o,n=xt.shouldEnumerateHeatMap(this.data.legendData,this.isFilledMap);switch(t.objectName){case"dataPoint":xt.shouldEnumerateDataPoints(this.dataView,this.isFilledMap,i)&&xt.enumerateDataPoints(e,this.data.legendData,this.data,this.dataView,this.style,this.featureSwitches);break;case"categoryLabels":xt.shouldEnumerateCategoryLabels(this.isFilledMap,this.filledMapDataLabelsEnabled,i)&&ft.DataLabelViewModel.enumerateCategoryLabels(e,a,!0,this.featureSwitches,!0,void 0,this.style);break;case"legend":this.hasSeries&&ft.Legend.enumerate({enumeration:e,legendData:this.data.legendData},this.featureSwitches);break;case"labels":this.filledMapDataLabelsEnabled&&(o={enumeration:e,dataLabelsSettings:a,show:!0,displayUnits:!0,precision:!0,style:this.style,bold:!0,italic:!0,underline:!0},ft.DataLabelViewModel.enumerateDataLabels(o,this.featureSwitches));break;case"bubbles":xt.enumerateBubbles(e,i);break;case"mapControls":this.enumerateMapControls(e,n);break;case"mapStyles":this.enumerateMapStyles(e);break;case"heatMap":n&&this.enumerateHeatMap(e)}return e.complete()}},xt.enumerateDataPoints=function(t,e,a,i,o,n){a&&(a.hasSeries?yt.colorEnumerationHelperModuleFactory().enumerateSeriesDataColors({enumeration:t,dataPoints:ft.LegendData.toIEnumerableDataPoints(e)},n):yt.colorEnumerationHelperModuleFactory().enumerateCategoryDataColors({enumeration:t,dataView:i,style:o,categories:_.map(a.dataPoints,function(t){var e=t.subDataPoints[0];return{color:bt.normalizeToHexString(e.fill),displayName:t.categoryValue,identity:e.identity}}),fillInstanceKind:3},n))},xt.enumerateBubbles=function(t,e){!e||e&&e.showHeatMap||t.pushInstance({selector:null,properties:{bubbleSize:ft.shapeUtil.invertBubbleSizeMultiplier(e.bubbleSizeMultiplier)},objectName:"bubbles",validValues:{bubbleSize:{numberRange:{min:-30,max:100}}}})},xt.prototype.enumerateMapControls=function(t,e){var a;this.data&&(a={autoZoom:this.data.properties.autoZoomEnabled,showZoomButtons:this.data.properties.showZoomButtons},!this.plotLassoManager||e&&this.data.properties.showHeatMap||(a.showLassoButton=this.data.properties.showLassoButton),a.geocodingCulture=this.data.properties.geocodingCulture,t.pushInstance({selector:null,properties:a,objectName:"mapControl"}))},xt.prototype.enumerateMapStyles=function(t){this.data&&t.pushInstance({selector:null,properties:{mapTheme:this.data.properties.mapTheme,showLabels:this.data.properties.showLabels},objectName:"mapStyles"})},xt.prototype.enumerateHeatMap=function(t){var e,a;!this.data||this.data.legendData&&!_.isEmpty(this.data.legendData.dataPoints)||(e=this.data.properties,a=ft.BingMapHeatMapUnit.maxRadiusPixels,e.heatMapOptions&&e.heatMapOptions.unit&&e.heatMapOptions.unit===ft.BingMapHeatMapUnit.meters&&(a=ft.BingMapHeatMapUnit.maxRadiusMeters),t.pushInstance({selector:null,properties:{show:e.showHeatMap,filterRadius:e.heatMapOptions&&e.heatMapOptions.radius,unit:e.heatMapOptions&&e.heatMapOptions.unit,transparency:e.heatMapOptions&&Math.round(100*(1-e.heatMapOptions.opacity)),color0:e.heatMapOptions&&e.heatMapOptions.colorGradient["0.20"],color50:e.heatMapOptions&&e.heatMapOptions.colorGradient[.65],color100:e.heatMapOptions&&e.heatMapOptions.colorGradient["1.00"]},objectName:"heatMap",validValues:{filterRadius:{numberRange:{min:1,max:a}}}}))},xt.prototype.update=function(e){return __awaiter(this,void 0,yt.Promise,function(){return __generator(this,function(t){switch(t.label){case 0:return null==e.resizeMode?[3,1]:(this.onResizingInternal(e),[3,3]);case 1:return[4,this.onDataChangedInternal(e)];case 2:t.sent(),t.label=3;case 3:return[2]}})})},xt.prototype.onDataChangedInternal=function(h,c){return void 0===c&&(c=!0),__awaiter(this,void 0,yt.Promise,function(){var e,a,i,o,n,s,r,l,u,d,p=this;return __generator(this,function(t){switch(t.label){case 0:return(this.viewMode=h&&h.viewMode,this.resetBounds(),this.geocodingContext&&this.geocodingContext.timeout&&this.geocodingContext.timeout.resolve(null),this.geocodingContext={timeout:this.promiseFactory.defer(),dataPointsRemaining:0},e=this.geocodingContext,this.behavior&&this.behavior.resetZoomPan(),o=this.dataView=h&&h.dataViews&&h.dataViews[0],a=this.isFilledMap,this.warnings=[],this.warningsSet=!1,i=xt.getDefaultMapData(this.style),o)?(i=this.data=xt.converter({dataView:o,geoTaggingAnalyzerService:this.geoTaggingAnalyzerService,isFilledMap:a,style:this.style,warnings:this.warnings}),this.dataPointRenderer.setData(i),this.hasSeries=i.hasSeries,[4,this.ensureMap()]):[3,2];case 1:if(t.sent(),this.mapControl){if((o=i.properties.mapTheme)!==this.mapTheme&&(this.mapControl.setMapType(Mt.mapTypeIdFromTheme(o)),this.mapTheme=o),n=this.mapControl.getOptions(),n.showZoomButtons!==i.properties.showZoomButtons||i.properties.minZoom&&n.minZoom!==i.properties.minZoom||i.properties.maxZoom&&n.maxZoom!==i.properties.maxZoom)return n=this.mapControl,this.mapControl=void 0,this.dataPointRenderer.clearDataPoints(),n.dispose(),setTimeout(function(){p.root.empty(),p.initializeMapControl(),c&&setTimeout(function(){return p.onDataChangedInternal(h,!1)},250)},xt.MapControlDisposeDelay),[2];if(i.properties.autoZoomEnabled&&!this.autoZoomWasEnabled?(i.properties.savedLatitude=void 0,i.properties.savedLongitude=void 0,i.properties.savedZoomLevel=void 0,this.persistZoomPanState(!0)):!i.properties.autoZoomEnabled&&this.autoZoomWasEnabled&&(this.updateZoomPanStateFromControl(),this.persistZoomPanState(!0)),this.autoZoomWasEnabled=i.properties.autoZoomEnabled,this.renderLegend(this.data.legendData),this.geocodingCategory=i.geocodingCategory,this.isDestroyed||e!==this.geocodingContext)return[2];for(s=void 0,a&&(s=Mt.getFilledMapParams(this.geocodingCategory,i.dataPoints.length)),e.dataPointsRemaining=i.dataPoints.length,r=0,l=i.dataPoints;r<l.length;r++)(u=l[r]).location?a&&!u.paths?this.enqueueGeoShape(e,u,s):this.addDataPoint(e,u):null!=(d=u.categoryValue)&&""!==d?a?this.enqueueGeoCodeAndGeoShape(e,u,s,i):this.enqueueGeoCode(e,u,i):this.geocodingFailed(e);this.updateInternal(!0,!0)}return!a||this.geocodingCategory&&this.geoTaggingAnalyzerService.isGeoshapable(this.geocodingCategory)||this.warnings.push(new ft.FilledMapWithoutValidGeotagCategoryWarning),i.invalidLatLongCoordinatesFound&&this.warnings.push(new ft.InvalidLatLongWarning),[3,3];case 2:this.clearDataPoints(),this.renderLegend(ft.Legend.getDefaultLegendData(this.style)),this.dataPointRenderer.setData(i),this.updateInternal(!0,!0),t.label=3;case 3:return this.host.setWarnings(this.warnings),this.warningsSet=!0,[2]}})})},xt.converter=function(e){if(xt.isMatrixCase(e.dataView))return xt.convertMatrix(e);var t=e.style,N=ft.mapProps.general.formatString,a=yt.data.createDataViewCategoricalReaderAdvanced(e.dataView,{colorOptions:{valueRole:st,visualStyle:t},formatStringProp:N}),i=a.data,o=a.objects,k=[],n=i.hasSeries(),s=i.hasValues(st),r=null,l=a.objects.getStaticObjects(),G=ft.shapeUtil.getBubbleSizeMultiplier(yt.DataViewObjects.getValue(l,ft.mapProps.bubbles.bubbleSize,1)),H=(100-yt.DataViewObjects.getValue(l,ft.mapProps.dataPoint.transparency,100*(1-xt.innerGeometryAlpha)))/100,u=e.isFilledMap,U=!1,Z=xt.getMapPropertiesFromObjects(l,t,G,!n,e);if(i.hasCategories()){var z=[],j=void 0;if(s){for(var d=void 0,p=void 0,h=0,c=i.getCategoryCount();h<c;h++){for(var g=void 0,m=0,v=i.getSeriesCount();m<v;m++){var A=i.getValue(st,h,m);null!=(g=null==g&&null!=A?0:g)&&(g+=A)}z.push(g),null!=g&&((void 0===d||g<d)&&(d=g),void 0===p||p<g)&&(p=g)}j=void 0!==d&&void 0!==p?{max:p,min:d}:void 0}var K=i.hasCompositeCategories()&&i.hasCategoryWithRole(Lt)&&i.hasCategoryWithRole(Dt),y=i.hasCategoryWithRole(Ct);if(y&&(r=xt.getGeocodingCategory(_.last(e.dataView.categorical.categories).source,e.geoTaggingAnalyzerService)),K||y)for(h=0,c=i.getCategoryCount();h<c;h++){var W={components:[],culture:Z.geocodingCulture},f=void 0,b=void 0,M=[],w=void 0,C=void 0,S=void 0,D=void 0,q=void 0;if(y){for(var X=i.getAllCategoryDisplayNamesForRole(Ct),Y=i.getAllCategoryValuesForRole(Ct,h),J=o.getAllCategoryFormatStringsForRole(Ct),$=_.map(e.dataView.categorical.categories,function(t){return xt.getGeocodingCategory(t.source,e.geoTaggingAnalyzerService)}),Q=[],L=0;L<Y.length;++L){var tt=X[L],et=Y[L],P=J[L],at=$[L],P=ft.valueFormatter.format(et,P);Q.unshift(P),W.components.push({query:et&&P,category:at}),M.push({displayName:tt,value:P})}f=Q.join(", "),i.hasValues(Dt)&&i.hasValues(Lt)&&(x=wt(i.getFirstNonNullValueForCategory(Dt,h)),I=wt(i.getFirstNonNullValueForCategory(Lt,h)),null!=x&&_.isFinite(x)&&null!=I&&_.isFinite(I)&&(b={latitude:x,longitude:I}),w={displayName:i.getValueDisplayName(Dt),value:ft.valueFormatter.format(x,o.getValueFormatString(Dt))},C={displayName:i.getValueDisplayName(Lt),value:ft.valueFormatter.format(I,o.getValueFormatString(Lt))})}else{var x=wt(i.getCategoryValue(Dt,h)),T=ft.valueFormatter.format(x,o.getCategoryFormatString(Dt)),I=wt(i.getCategoryValue(Lt,h)),it=ft.valueFormatter.format(I,o.getCategoryFormatString(Lt));Tt(x,I)&&(f=T+", "+it,b={latitude:x,longitude:I},w={displayName:i.getCategoryDisplayName(Dt),value:T},C={displayName:i.getCategoryDisplayName(Lt),value:it})}T=s?z[h]:void 0;if(Mt.latLongIsInvalid(b,K))U=!0;else{var ot=[],v=i.getSeriesCount();s||n||(v=1);for(m=0;m<v;m++){var V,F,B,E,nt,O=n?i.getSeriesName(m):void 0;n&&!s&&xt.hasNoValuesAtInteresection(a,[Pt,Lt,Dt],h,m)||(V=a.colors.createBySeries(m,h),(F=bt.parseColorString(V))||(V=a.colors.createBySeries(m,h,void 0,!0),F=bt.parseColorString(V)),V=xt.getSubDataPointStrokeColor(F,t),F=bt.rgbString(xt.adjustSubDataPointFillColor(F,t,H)),O=void(n&&(S={displayName:i.getSeriesDisplayName(),value:ft.valueFormatter.format(O,o.getSeriesFormatString())})),s&&(O=i.getValue(st,h,m),B=i.getFormatString(st,h,m)||a.objects.getValueFormatString(st),D={displayName:i.getValueDisplayName(st),value:ft.valueFormatter.format(O,B)}),i.hasValues(rt)&&(B=i.getValue(rt,h,m),E=a.objects.getValueFormatString(rt),q={displayName:i.getValueDisplayName(rt),value:ft.valueFormatter.format(B,E)}),E=[],_.isEmpty(M)||E.push.apply(E,M||[]),S&&E.push(S),w&&E.push(w),C&&E.push(C),D&&E.push(D),q&&E.push(q),ft.TooltipBuilder.addTooltipMeasures(a,E,h,m,N),nt=a.identities.createForDataPoint(h,m,s?[st]:void 0),(O||!s||0===O&&u)&&ot.push({value:O,fill:F,stroke:V,identity:nt,tooltipInfo:E,seriesIndex:m}))}(T||!s||0===T&&u)&&0<ot.length&&k.push({queryLocation:W,value:T,categoryValue:f,subDataPoints:ot,radius:xt.calculateRadius(j,T,G),location:b})}}}var r={dataPoints:k,geocodingCategory:r,hasSeries:n,hasSize:s,properties:Z,dataLabelSettings:xt.calculateDataLabelSettings(e.dataView,u,t),legendData:ft.Legend.buildSeriesLegendData({dataView:e.dataView,style:t,showByDefault:!0}),invalidLatLongCoordinatesFound:U},R=ft.ColorHelper.getDataColorByIndex(t,0),R=bt.createMonochromeScale(R,.33);return r.properties.heatMapOptions={opacity:1-yt.DataViewObjects.getValue(l,ft.mapProps.heatMap.transparency,0)/100,radius:yt.DataViewObjects.getValue(l,ft.mapProps.heatMap.filterRadius,10),unit:yt.DataViewObjects.getValue(l,ft.mapProps.heatMap.unit,yt.visuals.BingMapHeatMapUnit.defaultUnit),colorGradient:{"0.20":yt.DataViewObjects.getFillColor(l,ft.mapProps.heatMap.color0,R(0)),.65:yt.DataViewObjects.getFillColor(l,ft.mapProps.heatMap.color50,R(.5)),"1.00":yt.DataViewObjects.getFillColor(l,ft.mapProps.heatMap.color100,R(1))}},"meters"===r.properties.heatMapOptions.unit?r.properties.heatMapOptions.radius=Math.min(r.properties.heatMapOptions.radius,ft.BingMapHeatMapUnit.maxRadiusMeters):r.properties.heatMapOptions.radius=Math.min(r.properties.heatMapOptions.radius,ft.BingMapHeatMapUnit.maxRadiusPixels),r},xt.getMapPropertiesFromObjects=function(t,e,a,i,o){a={bubbleSizeMultiplier:a,autoZoomEnabled:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.autoZoom,!0),savedLatitude:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.centerLatitude),savedLongitude:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.centerLongitude),savedZoomLevel:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.zoomLevel),defaultDataPointColor:yt.DataViewObjects.getFillColor(t,ft.mapProps.dataPoint.defaultColor,e.colorPalette.dataColors.getColorByIndex(0).value),fill:yt.DataViewObjects.getFillColor(t,ft.mapProps.dataPoint.fill,e.colorPalette.dataColors.getColorByIndex(0).value),mapTheme:xt.getMapThemeFromObjects(t,e),showHeatMap:i&&yt.DataViewObjects.getValue(t,ft.mapProps.heatMap.show),showZoomButtons:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.showZoomButtons,!1),showLassoButton:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.showLassoButton,!1),minZoom:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.minZoom,void 0),maxZoom:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.maxZoom,void 0),showLabels:yt.DataViewObjects.getValue(t,ft.mapProps.mapStyles.showLabels,!0),showStroke:yt.DataViewObjects.getValue(t,ft.filledMapProps.stroke.show,!1),strokeColor:yt.DataViewObjects.getFillColor(t,ft.filledMapProps.stroke.color,void 0),strokeWidth:yt.DataViewObjects.getValue(t,ft.filledMapProps.stroke.width,void 0),geocodingCulture:yt.DataViewObjects.getValue(t,ft.mapProps.mapControls.geocodingCulture,void 0)};return a.geocodingCulture&&a.geocodingCulture!==ft.GeocodingCulture.Default&&a.geocodingCulture!==ft.GeocodingCulture.JA&&(a.geocodingCulture=void 0,o.warnings.push(new ft.InvalidGeocodingCulture)),a},xt.convertMatrix=function(e){var t=e.dataView.metadata.objects,a=e.dataView.matrix,i=e.style,o=[],n=a.rows.root.children;if(!n)return xt.getDefaultMapData(i);var s,r,l,u,d=ft.shapeUtil.getBubbleSizeMultiplier(yt.DataViewObjects.getValue(t,ft.mapProps.bubbles.bubbleSize,1)),N=(100-yt.DataViewObjects.getValue(t,ft.mapProps.dataPoint.transparency,100*(1-xt.innerGeometryAlpha)))/100,k=n.length,p={},G=0,H=xt.calculateRadius(void 0,void 0,d),U=a.rows.root.childIdentityFields,h=a.rows.levels[0].sources[0],c=ft.mapProps.general.formatString,Z=ft.ColorHelper.create(i,ft.mapProps.dataPoint.fill),z=!1,j=xt.getMapPropertiesFromObjects(t,i,d,!1,e);if(!_.isEmpty(a.valueSources))for(var A=[],g=0;g<a.valueSources.length;++g){var K=a.valueSources[g];K.roles[Pt]&&A.push({displayName:K.displayName,valueIndex:g})}var m,t=a.rows.levels[1];null==t||_.isEmpty(t.sources)||(m=t.sources,2<=t.sources.length&&(d=t.sources[0],t=t.sources[1],d&&d.roles[Lt]?(s=d,l=0):d&&d.roles[Dt]&&(r=d,u=0),t&&t.roles[Lt]?(s=t,l=1):t&&t.roles[Dt]&&(r=t,u=1)));for(var v=0;v<k;v++){var y=n[v],f=y.children,b=y.value,W=ft.converterHelper.formatFromMetadataColumn(b,h,ft.mapProps.general.formatString),q=Z.getColorForSeriesValue(y.objects,U,b),M=bt.parseColorString(q),X=(M||(q=Z.getColorForSeriesValue(y.objects,U,b,void 0,!0),M=bt.parseColorString(q)),xt.getSubDataPointStrokeColor(M,i)),Y=bt.rgbString(xt.adjustSubDataPointFillColor(M,i,N)),J={displayName:h.displayName,value:W};if(m&&m[0].roles[Ct])for(var w=m[m.length-1],C=xt.getGeocodingCategory(w,e.geoTaggingAnalyzerService),$=0,Q=f.length;$<Q;$++){var S=f[$],D=(E=(new ft.SelectionIdBuilder).withColumnIdentity(S.identity,w.queryName)).createSelectionId().getKey(),L=E.withColumnIdentity(y.identity,h.queryName).createSelectionId(),P=(null==(O=p[D])&&(O=G++,p[D]=O),[]),tt={components:[],culture:j.geocodingCulture},x=void 0;if(S.levelValues&&1!==S.levelValues.length){for(var et=_.map(m,function(t){return t.displayName}),at=_.map(S.levelValues,function(t){return t.value}),it=_.map(m,function(t){return yt.DataViewObjects.getValue(t.objects,{objectName:"general",propertyName:"formatString"})}),ot=_.map(m,function(t){return xt.getGeocodingCategory(t,e.geoTaggingAnalyzerService)}),nt=[],T=0;T<at.length;++T){var st=et[T],I=at[T],rt=it[T],lt=ot[T],I=ft.valueFormatter.format(I,rt);nt.unshift(I),tt.components.push({query:I,category:lt}),P.push({displayName:st,value:I})}x=nt.join(", ")}else{x=ft.converterHelper.formatFromMetadataColumn(S.value,w,c);D={displayName:w.displayName,value:x};P.push(D),tt.components.push({query:x,category:C})}(R=o[O])||(o[O]=R={categoryValue:x,queryLocation:tt,radius:H,subDataPoints:[],value:void 0}),P.push(J),R.subDataPoints.push({fill:Y,stroke:X,identity:L,value:void 0,tooltipInfo:P,seriesIndex:v})}else if(h&&h.roles[Ct]&&h.roles[St]){C=xt.getGeocodingCategory(h,e.geoTaggingAnalyzerService);b=(L=(new ft.SelectionIdBuilder).withColumnIdentity(y.identity,h.queryName).createSelectionId()).getKey();null==(O=p[b])&&(O=G++,p[b]=O),(R=o[O])||(o[O]=R={categoryValue:W,queryLocation:{components:[{query:W,category:C}]},radius:H,subDataPoints:[],value:void 0}),(P=[]).push(J),R.subDataPoints.push({fill:Y,stroke:X,identity:L,value:void 0,tooltipInfo:P,seriesIndex:v})}else{if(!(s&&s.roles[Lt]&&r&&r.roles[Dt]))return xt.getDefaultMapData(i);for(var ut=0,dt=f.length;ut<dt;ut++){var V=f[ut],F=wt(V.levelValues[l].value),B=wt(V.levelValues[u].value);if(Tt(B,F)){var E,pt=ft.converterHelper.formatFromMetadataColumn(F,s,c),ht=ft.converterHelper.formatFromMetadataColumn(B,r,c),P=[],x=ht+", "+pt,ct=(E=(new ft.SelectionIdBuilder).withColumnIdentity(V.identity,r.queryName)).createSelectionId().getKey(),L=E.withColumnIdentity(y.identity,h.queryName).createSelectionId();if(Mt.latLongIsInvalid(B={latitude:B,longitude:F},!0))z=!0;else{var O,R,F={displayName:r.displayName,value:ht},ht={displayName:s.displayName,value:pt};if(null==(O=p[ct])&&(O=G++,p[ct]=O),(R=o[O])||(o[O]=R={categoryValue:x,queryLocation:{components:[{query:x,category:C}]},radius:H,subDataPoints:[],value:void 0,location:B}),P.push(J),P.push(F),P.push(ht),!_.isEmpty(A))for(var gt=0,mt=A;gt<mt.length;gt++){var vt=mt[gt];P.push({displayName:vt.displayName,value:ft.valueFormatter.format(V.values[vt.valueIndex].value)})}R.subDataPoints.push({fill:Y,stroke:X,identity:L,value:void 0,tooltipInfo:P,seriesIndex:v})}}}}}return{dataPoints:o,hasSeries:!0,geocodingCategory:C,hasSize:!1,properties:j,dataLabelSettings:xt.calculateDataLabelSettings(e.dataView,e.isFilledMap,i),legendData:ft.Legend.buildFromFirstMatrixRowLevel({dataView:e.dataView,colorHelper:Z,style:i,formatStringProp:c,showByDefault:!0}),invalidLatLongCoordinatesFound:z}},xt.getMapThemeFromObjects=function(t,e){return e.isHighContrast?ft.BingMapTheme.highContrastTheme:yt.DataViewObjects.getValue(t,ft.mapProps.mapStyles.mapTheme,ft.BingMapTheme.defaultTheme)},xt.adjustSubDataPointFillColor=function(t,e,a){return void 0===a&&(a=xt.innerGeometryAlpha),t.A=e.isHighContrast?void 0:a,t},xt.getSubDataPointStrokeColor=function(t,e){return e.isHighContrast?ft.ColorHelper.getThemeColor(e,ft.ForegroundColorName):bt.hexString(bt.darken(t,xt.StrokeDarkenColorValue))},xt.isMatrixCase=function(t){return t.matrix&&!t.categorical},xt.getDefaultMapLabelSettings=function(t){var e=ft.ColorHelper.getThemeColor(t,ft.DataLabelViewModel.DefaultInsideLabelColorName),a=ft.DataLabelViewModel.getDefaultLabelSettings({style:t,labelColor:e,textClassName:"smallLightLabel"}).fontProperties,a=ft.FontProperties.inherit(a,{color:e});return{show:!1,showCategory:!1,position:0,displayUnits:0,precision:ft.DataLabelViewModel.defaultLabelPrecision,fontProperties:a,enableBackground:!0,backgroundColor:ft.ColorHelper.getThemeColor(t,ft.DataLabelViewModel.DefaultLabelBackgroundColorName),backgroundTransparency:Mt.DefaultFillOpacity,bold:!1,italic:!1,underline:!1}},xt.calculateDataLabelSettings=function(t,e,a){var i=xt.getDefaultMapLabelSettings(a),t=t.metadata&&t.metadata.objects;return t&&(i.showCategory=yt.DataViewObjects.getValue(t,ft.filledMapProps.categoryLabels.show,i.showCategory),e?(i.precision=yt.DataViewObjects.getValue(t,ft.filledMapProps.labels.labelPrecision,i.precision),i.precision=i.precision!==ft.DataLabelViewModel.defaultLabelPrecision&&i.precision<0?0:i.precision,i.displayUnits=yt.DataViewObjects.getValue(t,ft.filledMapProps.labels.labelDisplayUnits,i.displayUnits),(e=t.labels)&&(i.show=(void 0!==e.show?e:i).show,void 0!==e.color)&&(i.fontProperties=ft.FontProperties.inherit(i.fontProperties,{color:e.color.solid.color}))):(e=t.categoryLabels)&&ft.DataLabelViewModel.updateLabelSettingsFromLabelsObject(e,i,void 0,a),e=ft.ColorHelper.create(a),i.enableBackground=yt.DataViewObjects.getValue(t,ft.mapProps.categoryLabels.enableBackground,!0),i.backgroundColor=e.getColorForProperty(t,ft.mapProps.categoryLabels.backgroundColor,ft.DataLabelViewModel.DefaultLabelBackgroundColorName),i.backgroundTransparency=yt.DataViewObjects.getValue(t,ft.mapProps.categoryLabels.backgroundTransparency,100*Mt.DefaultFillOpacity)/100),i},xt.getDefaultMapData=function(t){return{dataPoints:[],hasSeries:!0,geocodingCategory:"",hasSize:!1,properties:{autoZoomEnabled:!0,showZoomButtons:!1,showLassoButton:!1,bubbleSizeMultiplier:1,savedLatitude:void 0,savedLongitude:void 0,savedZoomLevel:void 0,defaultDataPointColor:void 0,fill:void 0,mapTheme:ft.BingMapTheme.defaultTheme,showHeatMap:!1,minZoom:void 0,maxZoom:void 0,showLabels:!0},dataLabelSettings:this.getDefaultMapLabelSettings(t),legendData:ft.Legend.getDefaultLegendData(t),invalidLatLongCoordinatesFound:!1}},xt.hasNoValuesAtInteresection=function(t,e,a,i){for(var o=!1,n=0,s=e;n<s.length;n++){var r=s[n];if(t.data.hasValues(r)&&(o=!0,!_.every(t.data.getAllValuesForRole(r,a,i),function(t){return null==t})))return!1}return o},xt.prototype.swapLogoContainerChildElement=function(){var t,e,a=this.element.find(".LogoContainer");a&&null!=(t=a.find("a"))&&(e=$("<div>"),t.children().clone().appendTo(e),t.remove(),e.appendTo(a))},xt.prototype.onResizingInternal=function(t){t=t.viewport;t.scale=t.scale||1,this.currentViewport.width===t.width&&this.currentViewport.height===t.height&&this.currentViewport.scale===t.scale||(this.currentViewport=t,this.data&&this.data.legendData&&this.mapControl&&(this.renderLegend(this.data.legendData),this.updateInternal(!1,!1),Mt.renderAfterResize(this.mapControl)))},xt.prototype.ensureMap=function(){var t=this;return this.ensuringMap?this.ensuringMap.promise:(this.ensuringMap=yt.createJQueryPromiseFactory().defer(),this.mapControlFactory||(this.mapControlFactory=Mt.createDefaultMapControlFactory(this.promiseFactory,this.host.loader())),this.mapControlFactory.ensureMap(this.locale).then(function(){t.isDestroyed||(i.wrap(),t.initializeMapControl(),t.enableCurrentLocation&&t.createCurrentLocation(t.element))}))},xt.prototype.createMapControl=function(t,e){var a={credentials:Mt.Settings.BingKey,mapTypeId:Mt.mapTypeIdFromTheme(this.mapTheme),disableZooming:this.disableZooming,disablePanning:this.disablePanning,enableClickableLogo:!1,showDashboard:!0,showMapTypeSelector:!1,showLocateMeButton:!1,showZoomButtons:!1,showScalebar:!1,showTrafficButton:!1,allowHidingLabelsOfRoad:!0,enableInertia:!1},e=(e&&(a=__assign(__assign({},a),e)),this.mapControlFactory.createMapControl(t,a)),t=e.getZoomRange();return t&&(null!=t.min&&t.min>this.minLevelOfDetail&&(this.minLevelOfDetail=t.min),null!=t.max)&&t.max<this.maxLevelOfDetail&&(this.maxLevelOfDetail=t.max),e},xt.prototype.initializeMapControl=function(){var e,a,i,o=this,t=null==(t=this.data)?void 0:t.properties,n=this.data?{showZoomButtons:t.showZoomButtons,mapTypeId:Mt.mapTypeIdFromTheme(t.mapTheme),minZoom:t.minZoom,maxZoom:t.maxZoom}:null,s=(this.root||(this.root=InJs.DomFactory.div().addClass(xt.MapContainer.cssClass).css("position","absolute").appendTo(this.element[0]),this.disableZooming)||(e=!1,i=function(){e&&(r.setOptions({disableZooming:!1}),e=!1)},(s=this.root[0]).addEventListener("mouseup",function(t){0!==o.viewMode&&t.target.classList.contains("MicrosoftMap")&&(r.setOptions({disableZooming:!0}),e=!0,a=a||setTimeout(function(){a=void 0,i()}))},!0),s.addEventListener("mouseup",i,!1)),this.root),r=this.createMapControl(s[0],n);this.data&&t.mapTheme&&(this.mapTheme=t.mapTheme),this.data&&null!=t.autoZoomEnabled&&(this.autoZoomWasEnabled=t.autoZoomEnabled),this.mapControl=r,this.streetsideManager=new d(r,function(t){t?o.dataPointRenderer.hideDataPoints():(o.updateInternal(!0,!0),o.dataPointRenderer.showDataPoints(),o.updateZoomPanStateFromControl(),(t=o.data.properties)&&o.updateMapView(new Microsoft.Maps.Location(t.savedLatitude,t.savedLongitude),t.savedZoomLevel))}),this.dataPointRenderer.init(r,s,!!this.behavior,this.tooltipService,this.style,this.interactivityService,this.host,this.eventManager),this.behavior&&this.dataPointLassoSelect&&this.dataPointRenderer.getPlotAreaLassoSurface&&(n=this.dataPointRenderer.getPlotAreaLassoSurface(),t=d3.select(s[0]),this.plotLassoManager=new ft.PlotAreaLassoManager(!0),this.plotLassoManager.init([n,t],n,this.host,this.featureSwitches),this.lassoSelectionBehavior=new ft.LassoSelectionBehavior(this.behavior),this.plotLassoManager.behaviors.push(this.lassoSelectionBehavior),this.plotLassoManager.setUiScale(this.currentViewport.scale)),this.updateMapView(new Microsoft.Maps.Location(25,0),this.minLevelOfDetail),void 0!==this.viewChangeThrottleInterval?Microsoft.Maps.Events.addThrottledHandler(r,"viewchange",function(){o.onViewChanged()},this.viewChangeThrottleInterval):Microsoft.Maps.Events.addHandler(r,"viewchange",function(){o.onViewChanged()}),Microsoft.Maps.Events.addHandler(r,"viewchangeend",function(){o.onViewChangeEnded()}),this.streetsideManager.start(),this.pendingGeocodingRender||this.updateInternal(!0,!0),this.ensuringMap.resolve()},xt.prototype.onViewChanged=function(){!this.mapControl||this.streetsideManager.InStreetsideMode||this.data&&this.data.properties.showHeatMap||(this.updateOffsets(!1,!1),this.behavior&&this.behavior.viewChanged(),this.swapLogoContainerChildElement())},xt.prototype.onViewChangeEnded=function(){this.mapControl&&!this.streetsideManager.InStreetsideMode&&(this.onViewChanged(),this.data&&!1===this.data.properties.autoZoomEnabled&&(this.updateZoomPanStateFromControl(),this.persistZoomPanState(!1)),this.dataPointRenderer.updateInternalDataLabels(this.currentViewport,!0))},xt.prototype.getMapViewPort=function(){var t=this.currentViewport,e=this.legend.getMargins();if(this.rescaleMap){var a=this.currentViewport.scale;if(a)return{width:(t.width-e.width)*a,height:(t.height-e.height)*a}}return{width:t.width-e.width,height:t.height-e.height}},xt.prototype.updateInternal=function(t,e){var a,i,o=this.data&&this.data.properties;this.mapControl&&o&&(i=this.element.children(xt.MapContainer.selector),a=this.getMapViewPort(),i.height(a.height),i.width(a.width),this.rescaleMap&&(i.css("transform","scale("+1/this.currentViewport.scale+")"),i.css("transform-origin","left top")),this.updateOffsets(t,e),this.behavior&&this.behavior.mapKeyboardAccessibility(this.host,this.data.properties.showZoomButtons),this.behavior&&this.behavior.hasReceivedZoomOrPanEvent()||(this.shouldSetSavedLocation&&!1===o.autoZoomEnabled&&null!=o.savedLatitude&&null!=o.savedLongitude&&null!=o.savedZoomLevel?(this.updateMapView(new Microsoft.Maps.Location(o.savedLatitude,o.savedLongitude),o.savedZoomLevel),this.shouldSetSavedLocation=!1):this.boundsHaveBeenUpdated&&!0===o.autoZoomEnabled&&(t=(i=this.getMapView(a.width,a.height)).center,e=i.levelOfDetail,this.updateMapView(t,e),this.shouldSetSavedLocation=!0)))},xt.prototype.updateMapView=function(t,e){this.mapControl&&(e=Math.min(Math.max(e,this.minLevelOfDetail),this.maxLevelOfDetail),this.mapControl.setView({center:t,zoom:e,animate:!0,labelOverlay:this.data.properties.showLabels?Microsoft.Maps.LabelOverlay.visible:Microsoft.Maps.LabelOverlay.hidden}))},xt.prototype.updateMapViewOnFocus=function(){var t=this.getMapViewPort(),t=this.getMapView(t.width,t.height),e=t.center,t=t.levelOfDetail;this.updateMapView(e,t)},xt.prototype.updateOffsets=function(t,e){var a,i,o=this;this.streetsideManager.InStreetsideMode||(a=this.dataView,i=this.getMapViewPort(),a=a?this.dataPointRenderer.converter(i,this.data.dataLabelSettings,this.interactivityService,this.tooltipsEnabled,t):{bubbleData:[],shapeData:[],sliceData:[]},a=this.dataPointRenderer.updateInternal(a,i,t,this.interactivityService,e,this.behavior),this.plotLassoManager&&(this.plotLassoManager.setUiScale(this.currentViewport.scale),this.syncLassoButton()),a&&(a.focusCallback=function(){o.updateMapViewOnFocus()}),ft.Legend.positionChartArea(d3.select(this.root[0]),this.legend),this.interactivityService&&a&&(i=this.dataPointRenderer.getNavigationOptions(),this.interactivityService.bind(a.dataPoints,this.behavior,a,{navigationOptions:i,pointSourceKey:"map"})))},xt.prototype.onClearSelection=function(){this.interactivityService.clearSelection(),this.updateOffsets(!1,!1)},xt.prototype.onRestoreSelection=function(t){return!!this.interactivityService&&this.interactivityService.restoreSelection(t.selection)},xt.prototype.clearDataPoints=function(){this.dataPointRenderer.clearDataPoints(),this.legend.drawLegend(ft.Legend.getDefaultLegendData(this.style),this.currentViewport)},xt.prototype.updateZoomPanStateFromControl=function(){var t,e=this.data&&this.data.properties;e&&(t=this.mapControl.getCenter(),e.savedLatitude=t.latitude,e.savedLongitude=t.longitude,e.savedZoomLevel=this.mapControl.getZoom())},xt.prototype.persistZoomPanState=function(t){var e=this.data&&this.data.properties,a=e&&e.autoZoomEnabled,i=e&&e.showZoomButtons,o=e&&e.showLassoButton;e&&0!==this.viewMode&&(a||_.isFinite(e.savedLatitude)&&_.isFinite(e.savedLongitude)&&_.isFinite(e.savedZoomLevel),a={objectName:"mapControls",selector:null,properties:a?{autoZoom:!0,showZoomButtons:i,showLassoButton:o}:{autoZoom:!1,showZoomButtons:i,centerLatitude:e.savedLatitude,centerLongitude:e.savedLongitude,zoomLevel:e.savedZoomLevel,showLassoButton:o}},this.host.persistProperties({replace:[a]},t))},xt.prototype.syncLassoButton=function(){var t,e=this,a=d3.select(this.root[0]).select(Mt.NavBarSelector);a.empty()||(t=[],this.lassoButtonShouldExist()&&t.push(1),(t=(a=a.selectAll(Mt.MapLassoButtonSelector).data(t)).enter().append("a").classed(Mt.MapLassoButtonClass,!0).classed(Mt.NavBarButtonClass,!0).attr("id",Mt.MapLassoButtonId).attr("title",this.host.getLocalizedString(Mt.RectangleSelectKey)).attr("role","button").attr("aria-label",this.host.getLocalizedString(Mt.RectangleSelectKey)).on("click",function(){e.plotLassoManager.setForceLasso(!0),d3.event.stopPropagation()})).append("div").classed(Mt.NavButtonIconClass,!0).classed(Mt.MapLassoButtonHighContrastClass,this.style.isHighContrast),t.merge(a).classed(Mt.MapLassoButtonHighContrastClass,this.style.isHighContrast||this.data&&ft.BingMapTheme.useDarkButtonTheme(this.data.properties.mapTheme)),a.exit().remove())},xt.prototype.lassoButtonShouldExist=function(){var t=null==(t=this.data)?void 0:t.properties;return this.data&&!t.showHeatMap&&t.showLassoButton},xt.MapContainer={cssClass:"mapControl",selector:".mapControl"},xt.innerGeometryAlpha=.6,xt.StrokeDarkenColorValue=63.75,xt.ScheduleRedrawInterval=3e3,xt.MapControlDisposeDelay=1e3,ft.Map=xt,p.prototype.start=function(){var e=this;Microsoft.Maps.Events.addHandler(this.mapControl,"maptypechanged",function(t){return e.mapTypeChanged(t)})},p.prototype.mapTypeChanged=function(t){t.newMapTypeId===Microsoft.Maps.MapTypeId.streetside?this.InStreetsideMode||this.changeMode(!0):this.InStreetsideMode&&this.startTransitionToRoadTimeout()},p.prototype.cancelTransitionToRoadTimeout=function(){this.transitionToRoadTimeout&&(clearInterval(this.transitionToRoadTimeout),this.transitionToRoadTimeout=void 0)},p.prototype.startTransitionToRoadTimeout=function(){var t=this;this.transitionToRoadTimeout||(this.transitionToRoadTimeout=setInterval(function(){t.mapControl.getMapTypeId()===Microsoft.Maps.MapTypeId.streetside?t.cancelTransitionToRoadTimeout():null!=t.mapControl.tryLocationToPixel(new Microsoft.Maps.Location(0,0))&&t.changeMode(!1)},Mt.StreetsideModeManagerInterval))},p.prototype.changeMode=function(t){this.InStreetsideMode=t,this.cancelTransitionToRoadTimeout(),this.changedMode(t)};var i,t,n,r,l,u,d=p;function p(t,e){this.mapControl=t,this.changedMode=e,this.InStreetsideMode=this.mapControl.getMapTypeId()===Microsoft.Maps.MapTypeId.streetside}function h(t){try{return t.apply(null)}catch(t){a.error("Exception in Microsoft.Maps timeout callback",!1,void 0,{error:t&&t.stack||JSON.stringify(t)})}}(t=i=ft.WrapMapControlTimeout||(ft.WrapMapControlTimeout={})).unwrap=function(){n&&(r.setTimeout=l,r.setInterval=u,n=r=void 0)},t.wrap=function(){if(void 0===n){n=!1,r=Microsoft.Maps;var t=_.isFunction(r&&r.setTimeout),e=_.isFunction(r&&r.setInterval);if(r&&t&&e)try{l=r.setTimeout,u=r.setInterval,r.setTimeout=function(t,e){return l.apply(this,[function(){return h(t)},e])},r.setInterval=function(t,e){return u.apply(this,[function(){return h(t)},e])},n=!0}catch(t){r.setTimeout=l,r.setInterval=u,a.error("Unable to wrap Microsoft.Maps.setTimeout",!1,void 0,{error:t&&t.stack||JSON.stringify(t)})}else a.error("Unable to wrap Microsoft.Maps.setTimeout",!1,void 0,{gotMapsModule:!!r,setTimeoutIsFunction:t,setIntervalIsFunction:e})}}}(powerbi=powerbi||{}),function(o){var h,c,e,g;function t(){this.mapPointerEventsDisabled=!1,this.mapPointerTimeoutSet=!1,this.viewChangedSinceLastClearMouseDown=!1,this.receivedZoomOrPanEvent=!1,this.clearMouseDownLocation=new h.Point}h=o.visuals||(o.visuals={}),c=jsCommon.BrowserUtils,e=jsCommon.KeyUtils,g=o.visuals.shapes,t.prototype.bindEvents=function(t,e,a){function i(){var t=n.activeSelection,e=d3.event;t&&(n.mapPointerEventsDisabled||t.style("pointer-events","none"),n.mapPointerEventsDisabled=!0,e.preventDefault(),n.mapPointerTimeoutSet||(n.mapPointerTimeoutSet=!0,setTimeout(function(){t&&t.style("pointer-events","all"),n.mapPointerEventsDisabled=!1,n.mapPointerTimeoutSet=!1},500)))}var o,n=this,s=this.root=t.root,r=this.bubbles=t.bubbles,l=this.slices=t.slices,u=this.shapes=t.shapes,d=this.visualInstanceId=t.visualInstanceId,p=t.clearCapture;this.focusCallback=t.focusCallback,this.hostServices=t.hostServices,this.pointLabelText=this.hostServices.getLocalizedString("Generic_Point"),this.widthDivisor=t.widthDivisor,a&&(o=a.dataPointNavigationManager,a=a.pointSourceKey,this.dataPointNavigationManager=o,this.pointSourceKey=a),this.selectionHandler=e,this.hitTester=t.hitTester,s&&(this.registerArrowKeyStopper(s),this.dataPointNavigationManager)&&!this.dataPointNavigationManager.isEmpty(this.pointSourceKey)&&(h.InteractivityUtils.registerEnterPlotAreaHandler(s.select(h.MapUtil.PlotAreaSelector),this.dataPointNavigationManager,this.pointSourceKey),h.InteractivityUtils.appendUseElementForFocus(s,d,this.pointSourceKey),h.InteractivityUtils.registerClearCatcherShortcut(s,e)),this.mapPointerEventsDisabled||(r&&r.style("pointer-events","all"),l&&l.style("pointer-events","all"),u&&u.style("pointer-events","all"));r&&(this.activeSelection=r,t.bubbleEventGroup.on("mousewheel",i),this.registerMapSelectionHandler(t.bubbleEventGroup,e),h.InteractivityUtils.registerGroupContextMenuHandler(t.eventManager,t.bubbleEventGroup,e),this.dataPointNavigationManager)&&!this.dataPointNavigationManager.isEmpty(this.pointSourceKey)&&h.InteractivityUtils.registerDataPointNavigationHandler(t.bubbleEventGroup,this.dataPointNavigationManager,this.pointSourceKey),l&&(this.activeSelection=l,t.sliceEventGroup.on("mousewheel",i),this.registerMapSelectionHandler(t.sliceEventGroup,e),h.InteractivityUtils.registerGroupContextMenuHandler(t.eventManager,t.sliceEventGroup,e),this.dataPointNavigationManager)&&!this.dataPointNavigationManager.isEmpty(this.pointSourceKey)&&h.InteractivityUtils.registerDataPointNavigationHandler(t.sliceEventGroup,this.dataPointNavigationManager,this.pointSourceKey),u&&(this.activeSelection=u,t.shapeEventGroup.on("mousewheel",i),this.registerMapSelectionHandler(t.shapeEventGroup,e),h.InteractivityUtils.registerGroupContextMenuHandler(t.eventManager,t.shapeEventGroup,e),this.dataPointNavigationManager)&&!this.dataPointNavigationManager.isEmpty(this.pointSourceKey)&&h.InteractivityUtils.registerDataPointNavigationHandler(t.shapeEventGroup,this.dataPointNavigationManager,this.pointSourceKey),p&&(p.on("mouseup",function(){var t=d3.event;!n.shouldExitHandlerEarly(t)&&g.Point.getDistance(n.clearMouseDownLocation,new h.Point(t.x,t.y))<12&&!n.viewChangedSinceLastClearMouseDown&&!c.isCtrlOrMeta(t)&&(n.bubbles&&0!==n.bubbles.filter(function(){return this===t.target}).size()||n.slices&&0!==n.slices.filter(function(){return this===t.target}).size()||n.shapes&&0!==n.shapes.filter(function(){return this===t.target}).size()||e.handleClearSelection(),n.receivedZoomOrPanEvent=!0)},!0),p.on("mousedown",function(){var t=d3.event;n.viewChangedSinceLastClearMouseDown=!1,n.clearMouseDownLocation=new h.Point(t.x,t.y)},!0),p.on("mousewheel",function(){n.receivedZoomOrPanEvent=!0},!0)),t.navigationEntry&&h.InteractivityUtils.registerEnterPlotAreaHandler(d3.select(t.navigationEntry),this.dataPointNavigationManager,this.pointSourceKey)},t.prototype.bindHitTester=function(t){this.hitTester=t},t.prototype.renderSelection=function(e){this.bubbles&&this.bubbles.attr("aria-selected",function(t){return t.selected}).style("fill-opacity",function(t){return h.ColumnUtil.getFillOpacity(t.selected,!1,e,!1)}).style("stroke-opacity",function(t){return h.ColumnUtil.getFillOpacity(t.selected,!1,e,!1)}),this.slices&&this.slices.attr("aria-selected",function(t){return t.selected}).style("fill-opacity",function(t){return h.ColumnUtil.getFillOpacity(t.data.selected,!1,e,!1)}).style("stroke-opacity",function(t){return h.ColumnUtil.getFillOpacity(t.data.selected,!1,e,!1)}),this.shapes&&this.shapes.attr("aria-selected",function(t){return t.selected}).style("fill-opacity",function(t){return h.ColumnUtil.getFillOpacity(t.selected,!1,e,!1)}).style("stroke-opacity",function(t){return h.ColumnUtil.getFillOpacity(t.selected,!1,e,!1)})},t.prototype.viewChanged=function(){this.viewChangedSinceLastClearMouseDown=!0},t.prototype.resetZoomPan=function(){this.receivedZoomOrPanEvent=!1},t.prototype.hasReceivedZoomOrPanEvent=function(){return this.receivedZoomOrPanEvent},t.prototype.lassoSelectRect=function(t,e){this.hitTester&&(e=this.hitTester.queryRegion(e),h.InteractivityUtils.lassoSelectPoints(t,e,this.selectionHandler))},t.prototype.renderFocus=function(t){var e,a,i;t&&(this.bubbles&&this.bubbles.attr("aria-label",this.pointLabelText),this.slices&&this.slices.attr("aria-label",this.pointLabelText),this.shapes&&this.shapes.attr("aria-label",this.pointLabelText),e=d3.select(t),this.addAriaLabelToSelection(e),i=e.node().getBoundingClientRect(),a=e.node().viewportElement.getBoundingClientRect(),this.elementOutsideViewport(i,a)&&this.focusCallback(),i="".concat(h.CurrentFocusDataPointId,"-").concat(this.visualInstanceId),this.root.select("#"+i).attr("id",null),t.setAttribute("id",i),e.style("outline-width","".concat(1/this.widthDivisor,"px"),"important"),c.focus(t))},t.prototype.elementOutsideViewport=function(t,e){return t.x<e.x||t.y<e.y||t.x+t.width>e.x+e.width||t.y+t.height>e.y+e.height},t.prototype.registerMapSelectionHandler=function(t,a){var i=this;t.on("click",function(){var e=d3.event;i.shouldExitHandlerEarly(e)||o.visuals.EventBubblingUtil.handled(e)||h.InteractivityUtils.tryToSelectD3Target(function(t){i.bubbles&&i.bubbles.style("pointer-events","all").attr("aria-label",i.pointLabelText),i.slices&&i.slices.style("pointer-events","all").attr("aria-label",i.pointLabelText),i.shapes&&i.shapes.style("pointer-events","all").attr("aria-label",i.pointLabelText),i.mapPointerEventsDisabled=!i.slices,i.addAriaLabelToSelection(d3.select(e.target));t=h.InteractivityUtils.isSelectableDataPointContainer(t)?t.data:t;h.InteractivityUtils.handleSelection(t,a)})}).on("keydown.select",function(){var t=d3.event;i.shouldExitHandlerEarly(t)||32!==(t=t.keyCode)&&13!==t||h.InteractivityUtils.tryToSelectD3Target(function(t){t=h.InteractivityUtils.isSelectableDataPointContainer(t)?t.data:t;h.InteractivityUtils.handleSelection(t,a)},!0)},!0)},t.prototype.registerArrowKeyStopper=function(t){$(t.node()).keydown(function(t){e.isArrowKey(t.keyCode)&&(t.stopPropagation&&t.stopPropagation(),t.preventDefault)&&t.preventDefault()})},t.prototype.shouldExitHandlerEarly=function(t){return d3.select(t.target).classed(h.MapUtil.NavBarButtonClass)},t.prototype.addAriaLabelToSelection=function(t){t.attr("aria-label",function(t){return void 0!==t.data?h.tooltipUtils.formatTooltipInfo(t.data.tooltipInfo):h.tooltipUtils.formatTooltipInfo(t.tooltipInfo)})},t.prototype.setTabbableElements=function(){$(".bm_bottomRightOverlay a").attr("tabindex",0)},t.prototype.setNonTabbableElements=function(){$(".ms-composite").children("div").attr("tabindex",-1),$(".bm_bottomLeftOverlay a").attr("tabindex",-1)},t.prototype.mapKeyboardAccessibility=function(t,e){var a,i,o,n=this;this.root&&(a=this.root.select(h.MapUtil.NavBarSelector),i=this.root.select(h.MapUtil.PlotAreaSelector),a.empty()||this.root.selectAll(h.MapUtil.NavBarButtonDisplayedSelector).empty()||(o=jsCommon.BrowserUtils.isInternetExplorerOrEdge(),a.attr("tabindex",e?0:-1).attr("focusable",!!e).attr("role","region").attr("aria-label",t.getLocalizedString("Visual_AzureMapsNavigationControls")).attr("focus-nav-mode","Hierarchy").attr("style","position:absolute; inset: 4px 0px auto auto").classed(h.SetFocusRingClassName,!o),a.selectAll(h.MapUtil.ZoomButtonSelector).attr("tabindex",e?0:-1).attr("focusable","true"),a.select(h.MapUtil.MapLassoButtonSelector).attr("tabindex",-1),$(a.node()).one("focus",function(){n.setNonTabbableElements(),n.setTabbableElements()})),$(i.node()).one("focus",function(){n.setNonTabbableElements(),n.setTabbableElements()}),this.setNonTabbableElements(),this.setTabbableElements())},h.MapBehavior=t}(powerbi=powerbi||{}),function(h){var T=h.visuals||(h.visuals={});function c(t){this.navigationStrategy=T.DataPointNavigationStrategy.CategoryFirst,this.tooltipsEnabled=t}c.prototype.init=function(t,e,a,i,o,n,s,r){this.host=s,this.mapControl=t,this.eventManager=r,this.pointLabelText=this.host.getLocalizedString("Generic_Point");t=this.root=d3.select(e[0]),t.attr("drag-resize-disabled","true").style("display","inline-block").attr("tabindex",-1).attr("focusable",!1),r=jsCommon.BrowserUtils.isInternetExplorerOrEdge(),e=this.svg=t.append("svg").style("position","absolute").style("pointer-events","none").classed(T.MapUtil.PlotAreaClass,!r);n&&e.attr("tabindex",0).attr("focusable",!0).attr("aria-label",s.getLocalizedString("Visual_Plot")).attr("focus-nav-mode","Hierarchy").attr("aria-multiselectable","true").attr("role","listbox").classed(T.SetFocusRingClassName,!r),a&&(this.clearCapture=t),this.bubbleGraphicsContext=e.append("g").classed("mapBubbles",!0),this.sliceGraphicsContext=e.append("g").classed("mapSlices",!0),this.labelBackgroundGraphicsContext=e.append("g").classed(T.DataLabelViewModel.labelBackgroundGraphicsContextClass.class,!0),this.labelGraphicsContext=e.append("g").classed(T.DataLabelViewModel.labelGraphicsContextClass.class,!0),this.sliceLayout=d3.pie().value(function(t){return t.value}),this.arc=d3.arc(),this.style=o,this.clearMaxDataPointRadius(),this.dataLabelsSettings=T.Map.getDefaultMapLabelSettings(this.style),this.tooltipService=i},c.prototype.clearHeatMap=function(){this.mapControl&&this.mapControl.layers.clear(),this.heatMapLayer&&(this.heatMapLayer.clear(),this.heatMapLayer.dispose(),this.heatMapLayer=void 0)},c.prototype.setData=function(t){this.mapData=t},c.prototype.clearDataPoints=function(){this.style&&(this.mapData=T.Map.getDefaultMapData(this.style),this.clearHeatMap())},c.prototype.hideDataPoints=function(){this.svg.style("display","none")},c.prototype.showDataPoints=function(){this.svg.style("display","")},c.prototype.getDataPointCount=function(){return this.mapData?_.filter(this.mapData.dataPoints,function(t){return!!t.location}).length:0},c.prototype.getDataPointPadding=function(){return 2*this.maxDataPointRadius},c.prototype.clearMaxDataPointRadius=function(){this.maxDataPointRadius=0},c.prototype.setMaxDataPointRadius=function(t){this.maxDataPointRadius=Math.max(t,this.maxDataPointRadius)},c.prototype.converter=function(t,e,a,i){void 0===i&&(i=!0);var o=this.mapControl,n=t.width/2,s=t.height/2,r=(this.dataLabelsSettings=e,Math.min(t.width,t.height)/384),l=(this.clearMaxDataPointRadius(),[]),u=[],d=this.mapData?this.mapData.dataPoints:[],p=this.mapData&&this.mapData.hasSize;this.navigableDataPoints=void 0;for(var h=0,c=d.length;h<c;h++){var g=d[h],m=g.categoryValue,v=g.location;if(v&&!T.MapUtil.latLongIsInvalid(v,!0)){var y=o.tryLocationToPixel(new Microsoft.Maps.Location(v.latitude,v.longitude));if(y){var f=y.x+n,b=y.y+s,M=g.radius*r,w=(this.setMaxDataPointRadius(M),g.subDataPoints),C=w.length;if(1===C){var S={x:f,y:b,labeltext:m,radius:M,fill:(P=w[0]).fill,stroke:P.stroke,strokeWidth:1,tooltipInfo:P.tooltipInfo,identity:P.identity,selected:!1,labelFill:e.fontProperties.color,categoryIndex:h,seriesIndex:P.seriesIndex};l.push(S)}else{for(var D=[],L=0;L<C;L++){var P=w[L],x=p?P.value:1,S={x:f,y:b,labeltext:m,radius:M,fill:P.fill,stroke:P.stroke,strokeWidth:1,value:x,tooltipInfo:P.tooltipInfo,identity:P.identity,selected:!1,labelFill:e.fontProperties.color,categoryIndex:h,seriesIndex:P.seriesIndex};D.push(S)}a&&a.applySelectionStateToData(D),u.push(D)}}else JSON.stringify(v)}}return a&&a.applySelectionStateToData(l),{bubbleData:l,sliceData:u}},c.prototype.updateInternal=function(t,e,a,i,o,n){return this.mapRendererData=t,this.svg&&this.svg.style("width",e.width.toString()+"px").style("height",e.height.toString()+"px"),this.mapData&&this.mapData.properties.showHeatMap?this.renderHeatMapLayer(t):this.render(t,e,a,i,o)},c.getHeatMapLocations=function(t,e){var a=[],i=!1,o=_.filter(t,function(t){return null!=t.value});if(!_.isEmpty(o)){var n=_.map(o,function(t){return t.value}),s=_.min(n),r=_.max(n)-s;if(0<r){e.intensity=.1;for(var l=_.map(o,function(t){return Math.round((t.value-s)/r*9+1)}),u=0;u<o.length;u++)for(var d=o[u],p=l[u],h=0;h<p;h++)a.push(new Microsoft.Maps.Location(d.location.latitude,d.location.longitude));i=!0}}return a=i?a:_.map(t,function(t){return new Microsoft.Maps.Location(t.location.latitude,t.location.longitude)})},c.prototype.getPlotAreaLassoSurface=function(){return this.svg},c.prototype.renderHeatMapLayer=function(t){var e,a=this,i=(this.hideDataPoints(),this.mapData.properties.heatMapOptions&&((e=_.clone(this.mapData.properties.heatMapOptions)).intensity=.5),_.filter(this.mapData.dataPoints,function(t){return null!=t.location})),o=c.getHeatMapLocations(i,e);return Microsoft.Maps.loadModule("Microsoft.Maps.HeatMap",function(){a.heatMapLayer?(a.heatMapLayer.clear(),a.heatMapLayer.setLocations(o),a.heatMapLayer.setOptions(e)):(a.heatMapLayer=new Microsoft.Maps.HeatMapLayer(o,e),a.mapControl.layers.insert(a.heatMapLayer))}),{bubbleEventGroup:this.bubbleGraphicsContext,sliceEventGroup:this.sliceGraphicsContext,bubbles:null,slices:null,clearCapture:this.clearCapture,dataPoints:null,root:this.root,navigationEntry:this.clearCapture&&this.clearCapture[0]?this.clearCapture[0][0]:null,visualInstanceId:this.host.instanceId,eventManager:this.eventManager,hostServices:this.host}},c.prototype.render=function(t,e,a,i,o){for(var n=this.arc,s=i&&i.hasSelection(),r=jsCommon.BrowserUtils.isInternetExplorerOrEdge(),l=(this.heatMapLayer&&this.heatMapLayer.clear(),this.showDataPoints(),this.bubbleGraphicsContext.selectAll(".bubble").data(t.bubbleData,function(t){return t.identity.getKey()})),u=new T.MapItemMouseEventHandler(this.mapControl,this.tooltipService),d=l.enter().append("circle").classed("bubble",!0).merge(l),p=(d.classed(T.SetFocusRingClassName,!r&&!!i).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.radius}).attr("tabindex",i?0:null).attr("focusable",!!i).attr("aria-selected",function(t){return t.selected}).attr("role","option").attr("aria-label",this.pointLabelText).style("fill",function(t){return t.fill}).style("stroke",function(t){return t.stroke}).style("fill-opacity",function(t){return T.ColumnUtil.getFillOpacity(t.selected,!1,s,!1)}).style("strokeWidth",function(t){return t.strokeWidth}).style("stroke-opacity",function(t){return T.ColumnUtil.getFillOpacity(t.selected,!1,s,!1)}).on("mousedown.drag",function(){return u.onMouseDown(d3.event.target)}),l.exit().remove(),this.tooltipsEnabled&&(this.tooltipService.addTooltip(this.bubbleGraphicsContext,function(t){return t.data,t.data&&t.data.tooltipInfo},function(t){return t.data&&t.data.identity&&[t.data.identity]}),d.style("pointer-events","all")),t.sliceData),l=this.sliceGraphicsContext.selectAll(".sliceContainer").data(p),h=l.enter().append("g").classed("sliceContainer",!0).merge(l),c=(l.exit().remove(),this.sliceLayout),l=h.selectAll(".slice").data(function(t){return c(t)},function(t){return t.data.identity.getKey()}),h=l.enter().append("path").classed("slice",!0).merge(l),g=(h.classed(T.SetFocusRingClassName,!r&&!!i).style("fill",function(t){return t.data.fill}).style("fill-opacity",function(t){return T.ColumnUtil.getFillOpacity(t.data.selected,!1,s,!1)}).style("stroke",function(t){return t.data.stroke}).style("strokeWidth",function(t){return t.data.strokeWidth}).style("stroke-opacity",function(t){return T.ColumnUtil.getFillOpacity(t.data.selected,!1,s,!1)}).style("cursor","default").attr("transform",function(t){return T.SVGUtil.translate(t.data.x,t.data.y)}).attr("d",function(t){return n.innerRadius(0).outerRadius(function(t){return t.data.radius})(t)}).attr("tabindex",i?0:null).attr("focusable",!!i).on("mousedown.drag",function(){return u.onMouseDown(d3.event.target)}),l.exit().remove(),this.updateInternalDataLabels(e,o),this.tooltipsEnabled&&(this.tooltipService.addTooltip(this.sliceGraphicsContext,function(t){return t.data,t.data&&t.data.data&&t.data.data.tooltipInfo},function(t){return t.data&&t.data.data&&[t.data.data.identity]}),h.style("pointer-events","all")),t.bubbleData.slice()),m=0,v=p.length;m<v;m++)g.push.apply(g,p[m]);return{root:this.root,bubbleEventGroup:this.bubbleGraphicsContext,sliceEventGroup:this.sliceGraphicsContext,bubbles:_.isEmpty(t.bubbleData)?null:d,slices:_.isEmpty(t.sliceData)?null:h,clearCapture:this.clearCapture,dataPoints:g,navigationEntry:this.clearCapture&&this.clearCapture[0]?this.clearCapture[0][0]:null,visualInstanceId:this.host.instanceId,hitTester:new y({dataPoints:g}),eventManager:this.eventManager,hostServices:this.host}},c.prototype.updateInternalDataLabels=function(t,e){var a,i=this.dataLabelsSettings,o=[];i&&(i.show||i.showCategory)&&(i=this.createLabelDataPoints(),a=new h.LabelLayout({maximumOffset:T.DataLabelViewModel.maxLabelOffset,startingOffset:T.DataLabelViewModel.startingLabelOffset}),i={labelDataPoints:i,maxNumberOfLabels:i.length},o=a.layout([i],{width:t.width,height:t.height})),T.DataLabelRenderer.drawLabelsAndBackgrounds({labelContext:this.labelGraphicsContext,dataLabels:o,backgroundContext:this.labelBackgroundGraphicsContext,numeric:!1,formatMode:!1,onObject:!1})},c.prototype.createLabelDataPoints=function(){for(var t=this.mapRendererData,e=[],a=(a=t.bubbleData).concat(_.map(t.sliceData,function(t){return t[0]})),i=this.dataLabelsSettings,o=T.ColorHelper.getThemeColor(this.style,T.DataLabelViewModel.DefaultInsideLabelColorName),n=0,s=a;n<s.length;n++){var r=s[n],l=r.labeltext,u=i.fontProperties,d=T.FontProperties.toTextProperties(u,l),p=h.TextMeasurementService.measureSvgTextWidth(d),d=h.TextMeasurementService.estimateSvgTextHeight(d);e.push({isPreferred:!0,text:l,textSize:{width:p,height:d},outsideFill:u.color||o,insideFill:u.color||o,parentType:0,parentShape:{point:{x:r.x,y:r.y},radius:r.radius,validPositions:c.validLabelPositions},fontProperties:u,identity:void 0,hasBackground:i.enableBackground,backgroundColor:i.backgroundColor,backgroundTransparency:i.backgroundTransparency})}return e},c.prototype.getNavigationOptions=function(){return{helper:this,navigationStrategy:this.navigationStrategy}},c.prototype.getFirstElement=function(){this.navigableDataPoints=this.flattenViewModel();var t=_.find(this.navigableDataPoints,function(t){return!!t});return{element:this.getHtmlElementFromDataPoint(t)}},c.prototype.getNextDataPoint=function(t,e,a){_.isEmpty(this.navigableDataPoints)&&(this.navigableDataPoints=this.flattenViewModel());t=T.NavigationUtils.getNextFromFlattenedViewModel(this.navigableDataPoints,t,e,T.DataPointNavigationStrategy.CategoryFirst,a);return{element:this.getHtmlElementFromDataPoint(t)}},c.prototype.flattenViewModel=function(){var t=[];if(this.mapRendererData.bubbleData&&!_.isEmpty(this.mapRendererData.bubbleData)){for(var e=0,a=this.mapRendererData.bubbleData;e<a.length;e++){var i=a[e];t.push({categoryIndex:i.categoryIndex,seriesIndex:i.seriesIndex})}return t}if(this.mapRendererData.sliceData&&!_.isEmpty(this.mapRendererData.sliceData)){for(var o=0,n=this.mapRendererData.sliceData;o<n.length;o++)for(var s=0,r=n[o];s<r.length;s++){var l=r[s];t.push({categoryIndex:l.categoryIndex,seriesIndex:l.seriesIndex})}return t}},c.prototype.getHtmlElementFromDataPoint=function(e){var t=this.bubbleGraphicsContext.selectAll(".bubble").filter(function(t){return t.seriesIndex===e.seriesIndex&&t.categoryIndex===e.categoryIndex}).node();return t||this.sliceGraphicsContext.selectAll(".slice").filter(function(t){return t.data.seriesIndex===e.seriesIndex&&t.data.categoryIndex===e.categoryIndex}).node()||null},c.validLabelPositions=[1,2,4,8],T.MapBubbleDataPointRenderer=c,t.prototype.queryRegion=function(e){return _.filter(this.dataPoints,function(t){return T.shapes.Polygon.circleRectangleOverlap(e,{x:t.x,y:t.y},t.radius)})};var y=t;function t(t){this.dataPoints=t.dataPoints}T.MapBubbleHitTester=y}(powerbi=powerbi||{}),function(t){var u,e,d;function p(a,t,e){void 0===e&&(e=!0),this.mapControl=a,this.tooltipService=t,this.inertia=new u.Inertia(null,e),this.inertia.callback=function(t,e){return u.MapUtil.moveMapDelta(a,t,e)}}u=t.visuals||(t.visuals={}),e=jsCommon.CssConstants.createClassAndSelector,d=t.visuals.EventBubblingUtil,p.prototype.onMouseDown=function(t){var i=this,o=this.getMousePosition(),n=d3.select(t),s=!1,r=0,l=this.inertia,a=(l.hasStarted()&&l.stop(),d3.select(window).on(p.Events.mouseMove,function(){var t=i.getMousePosition(),e=p.getDelta(o,t),a=e[0],e=e[1];s||(r+=Math.abs(a)+Math.abs(e),p.DragPixelThreshold<r&&(s=!0,n.classed(p.DraggingCSS.class,!0),i.tooltipService.hide())),l.addPoint(t[0],t[1]),u.MapUtil.moveMapDelta(i.mapControl,a,e),o=t}).on(p.Events.mouseup,function(){var t,e;a.on(p.Events.mouseMove,null).on(p.Events.mouseup,null),s&&(t=i.getMousePosition(),l.addPoint(t[0],t[1]),n.classed(p.DraggingCSS.class,!1),(e=d3.event).target===n.node()&&n.on(p.Events.click,function(){d.markAsHandled(e),n.on(p.Events.click,null)}),l.start())}))},p.prototype.getMousePosition=function(){var t=p.BodyNode=p.BodyNode||d3.select("body").node();return d3.mouse(t)},p.getDelta=function(t,e){return[e[0]-t[0],e[1]-t[1]]},p.DragPixelThreshold=5,p.Events={mouseDown:"mousedown.mapDrag",mouseMove:"mousemove.mapDrag",mouseup:"mouseup.mapDrag",click:"click.mapDrag"},p.DraggingCSS=e("dragging-cursor"),u.MapItemMouseEventHandler=p}(powerbi=powerbi||{}),function(h){var D=h.visuals||(h.visuals={}),d=D.shapes.BoundingRectHelpers,i=h.visuals.DataPointNavigationStrategy,L=h.visuals.MapUtil,o=h.visuals.NavigationUtils,c=D.shapes.Polygon,S=h.visuals.SVGUtil;function P(t,e){this.navigationStrategy=i.CategoryFirst,this.filledMapDataLabelsEnabled=t,this.tooltipsEnabled=e}P.buildPaths=function(t){var e=[];if(!_.isEmpty(t))for(var a=0,i=t;a<i.length;a++){var o=i[a],n=o.geographic;n&&2<n.length&&e.push(o)}return e},P.prototype.init=function(t,e,a,i,o,n,s,r){this.host=s,this.mapControl=t,this.polygonInfo=new D.MapPolygonInfo;t=jsCommon.BrowserUtils.isInternetExplorerOrEdge(),this.eventManager=r,this.pointLabelText=this.host.getLocalizedString("Generic_Point"),r=this.root=d3.select(e[0]),r.attr("drag-resize-disabled","true").attr("tabindex",-1).attr("focusable",!1),e=this.svg=r.append("svg").style("position","absolute").style("pointer-events","none").classed(L.PlotAreaClass,!t);n&&e.attr("tabindex",0).attr("focusable",!0).attr("aria-label",s.getLocalizedString("Visual_Plot")).attr("focus-nav-mode","Hierarchy").attr("aria-multiselectable","true").attr("role","listbox").classed(D.SetFocusRingClassName,!t),a&&(this.clearCapture=r),this.shapeGraphicsContext=e.append("g").classed("mapShapes",!0),this.labelGraphicsContext=e.append("g").classed(D.DataLabelViewModel.labelGraphicsContextClass.class,!0),this.style=o,this.clearMaxShapeDimension(),this.dataLabelsSettings=D.Map.getDefaultMapLabelSettings(this.style),this.tooltipService=i},P.prototype.setData=function(t){this.mapData=t},P.prototype.clearDataPoints=function(){this.style&&(this.mapData=D.Map.getDefaultMapData(this.style))},P.prototype.hideDataPoints=function(){this.svg.style("display","none")},P.prototype.showDataPoints=function(){this.svg.style("display","")},P.prototype.getDataPointCount=function(){return this.mapData?_.filter(this.mapData.dataPoints,function(t){return!!t.paths}).length:0},P.prototype.converter=function(t,e,a,i,o){if(void 0===i&&(i=!0),!(o=void 0===o?!0:o)&&this.mapRendererData)return this.mapRendererData;this.navigableDataPoints=void 0,this.clearMaxShapeDimension(),this.dataLabelsSettings=e;for(var n=[],s=this.mapData?this.mapData.dataPoints:[],r=0,l=s.length;r<l;r++){var u=s[r],d=u.subDataPoints[0],p=u.paths;if(!_.isEmpty(p)){for(var h,c,g,m=u.value,u=u.categoryValue,v=d.identity,y=v.getKey(),f=void 0,b=void 0,M=p.length;0<M--;){var w,C=p[M];C&&C.absoluteBounds?(this.setMaxShapeDimension(C.absoluteBounds.width,C.absoluteBounds.height),w={left:C.absoluteBounds.left,top:C.absoluteBounds.top,right:C.absoluteBounds.left+C.absoluteBounds.width,bottom:C.absoluteBounds.top+C.absoluteBounds.height},f?(w.left<f.left&&(f.left=w.left),w.top<f.top&&(f.top=w.top),w.right>f.right&&(f.right=w.right),w.bottom>f.bottom&&(f.bottom=w.bottom)):(f={left:w.left,top:w.top,right:w.right,bottom:w.bottom},b=[]),b.push({boundingRect:w,path:C.absolute})):p.splice(M,1)}_.isEmpty(p)||(h=p[P.getIndexOfLargestShape(p)].absolute,c=_.map(p,function(t){return S.XYArrayToPath(t.absolute)}).join(" "),g=void 0,this.mapData.properties.showStroke&&(g=_.map(p,function(t){return S.XYArrayToReducedPath(t.absolute,P.ReducedPathScale)}).join(" ")),n.push({mainShapePointArray:h,path:c,reducedPath:g,fill:d.fill,stroke:d.stroke,strokeWidth:1,tooltipInfo:d.tooltipInfo,identity:v,selected:!1,key:JSON.stringify({id:y}),labeltext:u,catagoryLabeltext:null!=m?m.toString():void 0,categoryIndex:r,seriesIndex:d.seriesIndex,absoluteCenter:{x:(f.left+f.right)/2,y:(f.top+f.bottom)/2},globalBoundingRect:f,pathsWithBounds:b}))}}return a&&a.applySelectionStateToData(n),{shapeData:n}},P.prototype.useReducedPaths=function(t){return this.mapData.properties.showStroke&&t<P.ReducedPathScaleLimit},P.prototype.updateInternal=function(t,e,a,i,o,n){this.mapRendererData=t,this.svg&&this.svg.style("width",e.width.toString()+"px").style("height",e.height.toString()+"px"),this.polygonInfo.reCalc(this.mapControl,e.width,e.height);function s(t,e,a){var i=l.applyToPoint(t.absoluteCenter),o=l.applyToPoint({x:t.absoluteCenter.x-e,y:t.absoluteCenter.y}),e=l.applyToPoint({x:t.absoluteCenter.x+e,y:t.absoluteCenter.y}),t=Math.abs(i.x-g),i=Math.abs(o.x-g),o=Math.abs(e.x-g);return c(i<t,o<t,a)}var r=this.polygonInfo.scale,l=this.polygonInfo.transform,u=L.getAbsoluteMapSize(),d=l,p=u,h=this.useReducedPaths(r),c=(h&&((m=_.clone(d.matrix)).m00=m.m11=r/P.ReducedPathScale,d=new D.Transform(m),p=L.getMapSize(P.ReducedPathZoomLevel)),this.shapeGraphicsContext.attr("transform",this.polygonInfo.transformToString(d)),function(t,e,a){return t?-a:e?a:0}),g=e.width/2,m=this.shapeGraphicsContext.selectAll("path").data(t.shapeData,function(t){return t.key}).style("transform",function(t){return"translateX(".concat(s(t,u,p),"px)")}),v=h?function(t){return t.reducedPath}:function(t){return t.path},y=new D.MapItemMouseEventHandler(this.mapControl,this.tooltipService),f=m.enter().append("path").classed("shape",!0).attr("aria-selected",function(t){return t.selected}).attr("role","option").attr("aria-label",this.pointLabelText).attr("d",v).on("mousedown.drag",function(){return y.onMouseDown(d3.event.target)}).merge(m),b=h?r/P.ReducedPathScale:this.polygonInfo.scale,M=i&&i.hasSelection(),w=(f.classed(D.SetFocusRingClassName,!!i).attr("tabindex",i?0:null).attr("focusable",!!i).style("fill",function(t){return t.fill}).style("fill-opacity",function(t){return D.ColumnUtil.getFillOpacity(t.selected,!1,M,!1)}).style("outline-width","".concat(1/b,"px")),this.mapData.properties.strokeColor),C=this.mapData.properties.strokeWidth,r=this.style.isHighContrast?(S=function(t){return t.stroke},function(t){return t.strokeWidth/b}):this.mapData.properties.showStroke?(S=function(t){return w||t.stroke},function(t){return(C||t.strokeWidth)/b}):S=null,i=(f.style("stroke",S).style("stroke-width",r),this.lastRenderUsedReducedPaths!==h),S=((a||i)&&f.attr("d",v),this.lastRenderUsedReducedPaths=h,m.exit().remove(),this.updateInternalDataLabels(e,o),new x({absMapSize:u,applyOffset:c,dataPoints:t.shapeData,mapControl:this.mapControl,offset:p,transform:d,translateX:s,viewport:e}));if(a)return this.tooltipsEnabled&&(this.tooltipService.addTooltip(this.shapeGraphicsContext,function(t){return t.data,t.data&&t.data.tooltipInfo},function(t){return t.data&&t.data.identity&&[t.data.identity]}),f.style("pointer-events","all")),{root:this.root,shapeEventGroup:this.shapeGraphicsContext,shapes:f,clearCapture:this.clearCapture,dataPoints:t.shapeData,navigationEntry:this.clearCapture&&this.clearCapture[0]?this.clearCapture[0][0]:null,visualInstanceId:this.host.instanceId,hitTester:S,eventManager:this.eventManager,hostServices:this.host,widthDivisor:b};n&&n.bindHitTester(S)},P.prototype.getDataPointPadding=function(){return 12},P.prototype.getEnclosingBounds=function(){var t,e=this.mapData&&this.mapData.dataPoints;if(!_.isEmpty(e))for(var a=0,i=e;a<i.length;a++){var o=i[a].paths;if(!_.isEmpty(o))for(var n=0,s=o;n<s.length;n++){var r=s[n];r.geographic&&(t=L.expandLocationRect(t,r.adjustedBounds))}}return t},P.getIndexOfLargestShape=function(t){for(var e=0,a=0,i=0,o=t.length;i<o;i++){var n=t[i],n=new c(n.absolute),n=Math.abs(c.calculateAbsolutePolygonArea(n.polygonPoints));a<n&&(e=i,a=n)}return e},P.prototype.updateInternalDataLabels=function(t,e){var a,i=this.dataLabelsSettings,o=[];i&&(i.show||i.showCategory)&&(a=this.createLabelDataPoints(),void 0===this.labelLayout&&(this.labelLayout=new h.FilledMapLabelLayout),o=this.labelLayout.layout(a,{width:t.width,height:t.height},this.polygonInfo.transform,e)),this.drawLabelStems(this.labelGraphicsContext,o,i.show,i.showCategory),D.DataLabelRenderer.drawLabelBackground({context:this.labelGraphicsContext,dataLabels:o,formatMode:!1,onObject:!1}),D.DataLabelRenderer.drawDefaultLabels({labelContext:this.labelGraphicsContext,dataLabels:o,twoRows:i.show&&i.showCategory,formatMode:!1,onObject:!1})},P.prototype.getPlotAreaLassoSurface=function(){return this.svg},P.prototype.clearMaxShapeDimension=function(){this.maxShapeDimension=0},P.prototype.setMaxShapeDimension=function(t,e){this.maxShapeDimension=Math.max(t,this.maxShapeDimension),this.maxShapeDimension=Math.max(e,this.maxShapeDimension)},P.prototype.createLabelDataPoints=function(){var t=this.mapRendererData,e=[];if(this.filledMapDataLabelsEnabled)for(var t=t.shapeData,a=this.dataLabelsSettings,i=0,o=t;i<o.length;i++){var n=o[i],s=void 0,r=void 0,l=0,u=!1;if(this.dataLabelsSettings.show&&!this.dataLabelsSettings.showCategory){if(void 0===(s=n.catagoryLabeltext))continue}else if(this.dataLabelsSettings.showCategory&&!this.dataLabelsSettings.show){if(void 0===(s=n.labeltext))continue}else if(this.dataLabelsSettings.showCategory&&this.dataLabelsSettings.show){if(s=n.catagoryLabeltext,r=n.labeltext,void 0===s&&void 0===r)continue;u=!0}var d=D.DataLabelViewModel.getDefaultLabelSettings({style:this.style,textClassName:"smallLightLabel",noColor:!0}).fontProperties,u=(u&&(u=D.FontProperties.toTextProperties(d,r),l=h.TextMeasurementService.measureSvgTextWidth(u)),D.FontProperties.toTextProperties(d,s)),d=h.TextMeasurementService.measureSvgTextWidth(u),u=h.TextMeasurementService.estimateSvgTextHeight(u),p=(r&&void 0!==n.labeltext&&void 0!==n.catagoryLabeltext&&(u*=2),D.ColorHelper.getThemeColor(this.style,D.DataLabelViewModel.DefaultInsideLabelColorName)),n={parentType:2,parentShape:{polygon:new c(n.mainShapePointArray),validPositions:P.validLabelPolygonPositions},text:s,secondRowText:r,textSize:{width:Math.max(d,l),height:u},insideFill:a.fontProperties.color,outsideFill:a.fontProperties.color||p,isPreferred:!1,identity:void 0,hasBackground:!0,fontProperties:a.fontProperties};e.push(n)}return e},P.prototype.drawLabelStems=function(t,e,a,i){var o=D.ColorHelper.getThemeColor(this.style,L.LeaderLineColorName);D.DataLabelRenderer.drawLabelLeaderLines(t,e,function(t,e){return t.identity?t.identity.getKeyWithoutHighlight():e},o)},P.prototype.getNavigationOptions=function(){return{helper:this,navigationStrategy:this.navigationStrategy}},P.prototype.getFirstElement=function(){this.navigableDataPoints=this.flattenViewModel();var t=_.find(this.navigableDataPoints,function(t){return!!t});return{element:this.getHtmlElementFromDataPoint(t)}},P.prototype.getNextDataPoint=function(t,e,a){_.isEmpty(this.navigableDataPoints)&&(this.navigableDataPoints=this.flattenViewModel());t=o.getNextFromFlattenedViewModel(this.navigableDataPoints,t,e,i.CategoryFirst,a);return{element:this.getHtmlElementFromDataPoint(t)}},P.prototype.flattenViewModel=function(){var t=[];if(this.mapRendererData.shapeData)for(var e=0,a=this.mapRendererData.shapeData;e<a.length;e++){var i=a[e];t.push({categoryIndex:i.categoryIndex,seriesIndex:i.seriesIndex})}return t},P.prototype.getHtmlElementFromDataPoint=function(e){var t=this.shapeGraphicsContext.selectAll(".shape").filter(function(t){return t.categoryIndex===e.categoryIndex&&t.seriesIndex===e.seriesIndex}).node();return t||null},P.validLabelPolygonPositions=[256,2,1,8,4,16,32,64,128],P.ReducedPathScale=.0078125,P.ReducedPathScaleLimit=.03125,P.ReducedPathZoomLevel=4,D.MapShapeDataPointRenderer=P,t.prototype.queryRegion=function(t){var e=this.transformAndTranslateSelectionRectangle(t);if(!e)return[];this.lazyCalculateTranslations||(this.dataPoints=this.calculateTranslations(this.originalDataPoints),this.lazyCalculateTranslations=!0);for(var a=[],i=0,o=this.dataPoints;i<o.length;i++){var n=o[i],s=c.translateX(e,-n.translation);if(c.polygonBoundsOverlap(s,d.getPolygonFromBoundingRect(n.mapShape.globalBoundingRect)))for(var r=0,l=n.mapShape.pathsWithBounds;r<l.length;r++){var u=l[r];if(c.polygonBoundsOverlap(s,d.getPolygonFromBoundingRect(u.boundingRect))&&s.overlapPath(u.path)){a.push(n.mapShape);break}}}return a},t.prototype.transformAndTranslateSelectionRectangle=function(t){var s=this,r=new Float64Array(8),e=new Float64Array(8),a={x:0,y:0},l=this.transform.applyToPoint(a).x,u=(a.x+=this.absMapSize,this.transform.applyToPoint(a).x);if(!d.generatePointsFromBounds(t,function(t,e,a,i,o){var n=t-s.viewport.width/2,e=e-s.viewport.height/2,n=new Microsoft.Maps.Point(n,e),e=s.mapControl.tryPixelToLocation(n,Microsoft.Maps.PixelReference.viewport);if(!e)return!1;r[a]=e.latitude,r[a+1]=e.longitude;n=s.applyOffset(t<l,u<t,s.offset);return o[a]=n,!(o[a+1]=0)},r,e))return null;for(var i=L.latLongToPixelXYArray(r,this.absMapSize),o=0;o<i.length;o++)i[o]+=e[o];return new c(i)},t.prototype.calculateTranslations=function(t){for(var e=[],a=0,i=t;a<i.length;a++){var o=i[a];e.push({mapShape:o,translation:this.translateX(o,this.absMapSize,this.offset)})}return e};var x=t;function t(t){this.absMapSize=t.absMapSize,this.applyOffset=t.applyOffset,this.lazyCalculateTranslations=!1,this.mapControl=t.mapControl,this.offset=t.offset,this.originalDataPoints=t.dataPoints,this.transform=t.transform,this.translateX=t.translateX,this.viewport=t.viewport}D.MapShapeHitTester=x}(powerbi=powerbi||{}),function(t){((t=t.powerbi||(t.powerbi={})).visuals||(t.visuals={})).importMapModule=function(){}}(es6=es6||{}),function(t){var e;(e=t.visuals||(t.visuals={})).initializeMapFactoryES6=function(){e.setCreateMap(function(e){return es6.powerbi.visuals.importMapModule().then(function(t){return new t.Map(e)})})}}(powerbi=powerbi||{});
this.parseTimeMarkers = this.parseTimeMarkers || {};
var marker = this.parseTimeMarkers['mapVisuals.min.js'] || (this.parseTimeMarkers['mapVisuals.min.js'] = {});
marker.endEval = window.jsCommon && window.jsCommon.performance && window.jsCommon.performance.now ? window.jsCommon.performance.now() : Date.now(); marker.isExternal = false;
